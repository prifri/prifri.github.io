<!doctype html>
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.68.3" />
<link rel="canonical" type="text/html" href="/docs/linux-arm64-kernel/source-studty/per-cpu/">
<link rel="alternate" type="application/rss&#43;xml" href="/docs/linux-arm64-kernel/source-studty/per-cpu/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>per cpu | Goldydocs</title>
<meta name="description" content="setup_per_cpu_areas
">
<meta property="og:title" content="per cpu" />
<meta property="og:description" content="setup_per_cpu_areas
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/linux-arm64-kernel/source-studty/per-cpu/" />
<meta property="og:updated_time" content="2022-01-14T00:00:00+00:00" /><meta property="og:site_name" content="Goldydocs" />
<meta itemprop="name" content="per cpu">
<meta itemprop="description" content="setup_per_cpu_areas
"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="per cpu"/>
<meta name="twitter:description" content="setup_per_cpu_areas
"/>




<link rel="preload" href="/scss/main.min.d104b09df4e09a1f9848d902cf944f7d780e940fbb4e2c3d73b3f5546bcbfaea.css" as="style">
<link href="/scss/main.min.d104b09df4e09a1f9848d902cf944f7d780e940fbb4e2c3d73b3f5546bcbfaea.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zM197.0804 232.033c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zM197.0839 232.0372c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zM197.0839 232.0372c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zM197.0804 177.6188c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zM197.0839 177.623c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zM197.0839 177.623c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zM197.5309 286.4723c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zM197.5344 286.4765c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zM197.5344 286.4765c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zM197.0804 340.5784c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zM197.0839 340.5826c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zM197.0839 340.5826c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Goldydocs</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/blog/" ><span>Blog</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/community/" ><span>Community</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; 사이트에서 검색…" aria-label="사이트에서 검색…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
이 섹션의 다중 페이지 출력 화면임.
<a href="#" onclick="print();return false;">여기를 클릭하여 프린트</a>.
</p><p>
<a href="/docs/linux-arm64-kernel/source-studty/per-cpu/">이 페이지의 일반 화면으로 돌아가기</a>.
</p>
</div>



<h1 class="title">per cpu</h1>
<div class="lead">setup_per_cpu_areas</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-4e18266c986768ca76a8ded008df6603">mm_percpu_c</a></li>


    
  
    
    
	
<li>2: <a href="#pg-ea349711d868e9d1493dd1bcf661a200">scan_hint</a></li>


    
  

    </ul>


<div class="content">
      

<div class="pageinfo pageinfo-primary">
<p>setup_per_cpu_areas</p>

</div>


</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-4e18266c986768ca76a8ded008df6603">1 - mm_percpu_c</h1>
    <div class="lead"><a href="https://github.com/iamroot18/5.10/blob/i515/mm/percpu.c">study</a> mm/percpu.c</div>
	<h2 id="pcpu_embed_first_chunk">pcpu_embed_first_chunk</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">__init</span> <span style="color:#000">pcpu_embed_first_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">size_t</span> <span style="color:#000">reserved_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">dyn_size</span><span style="color:#000;font-weight:bold">,</span>
				  <span style="color:#000">size_t</span> <span style="color:#000">atom_size</span><span style="color:#000;font-weight:bold">,</span>
				  <span style="color:#000">pcpu_fc_cpu_distance_fn_t</span> <span style="color:#000">cpu_distance_fn</span><span style="color:#000;font-weight:bold">,</span>
				  <span style="color:#000">pcpu_fc_alloc_fn_t</span> <span style="color:#000">alloc_fn</span><span style="color:#000;font-weight:bold">,</span>
				  <span style="color:#000">pcpu_fc_free_fn_t</span> <span style="color:#000">free_fn</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">base</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ULONG_MAX</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">areas</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_alloc_info</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ai</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">size_t</span> <span style="color:#000">size_sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">areas_size</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">max_distance</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">group</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">highest_group</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * IAMROOT, 2022.01.08: 
</span><span style="color:#8f5902;font-style:italic"> * pcpu_alloc_info 구조체를 할당해온다.
</span><span style="color:#8f5902;font-style:italic"> * - setup_per_cpu_areas 에서 불러진 경우
</span><span style="color:#8f5902;font-style:italic"> *   @reserved_size PERCPU_MODULE_RESERVE. 8k
</span><span style="color:#8f5902;font-style:italic"> *   @dyn_size PERCPU_DYNAMIC_RESERVE 28k
</span><span style="color:#8f5902;font-style:italic"> *   @atom_size PAGE_SIZE
</span><span style="color:#8f5902;font-style:italic"> *   @cpu_distance_fn pcpu_cpu_distance,
</span><span style="color:#8f5902;font-style:italic"> */</span>
	<span style="color:#000">ai</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_build_alloc_info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reserved_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dyn_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">atom_size</span><span style="color:#000;font-weight:bold">,</span>
				   <span style="color:#000">cpu_distance_fn</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">IS_ERR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ai</span><span style="color:#000;font-weight:bold">))</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">PTR_ERR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ai</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">size_sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">static_size</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">reserved_size</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dyn_size</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">areas_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PFN_ALIGN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_groups</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">));</span>

	<span style="color:#000">areas</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">memblock_alloc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">areas_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SMP_CACHE_BYTES</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">areas</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">rc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ENOMEM</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">out_free</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>@size_sun  unit size를 구함
@areas_size group배열에 필요한 사이즈를 구함
@areas memblock에서 group 배열을 할당해왔음.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#8f5902;font-style:italic">/* allocate, copy and determine base address &amp; max_distance */</span>
	<span style="color:#000">highest_group</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">group</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">group</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_groups</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">group</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_group_info</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">gi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">groups</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">group</span><span style="color:#000;font-weight:bold">];</span>
		<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cpu</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">NR_CPUS</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">gi</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_units</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">cpu</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">NR_CPUS</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#000">cpu</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gi</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">cpu_map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
		<span style="color:#000">BUG_ON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cpu</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">NR_CPUS</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>pcpu_build_alloc_info 에서 초기화됬던 pcpu_group_info를 가져오고 거기서 첫번째 cpu_map을 찾아온다. 순서대로 넣었으니 기본적으로 0번일것이다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">		<span style="color:#8f5902;font-style:italic">/* allocate space for the whole group */</span>
		<span style="color:#000">ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">alloc_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gi</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_units</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">unit_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">atom_size</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">rc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ENOMEM</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">out_free_areas</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>@ptr group에서 사용할 unit memory block. 총 unit 크기여야하니 unit개수 * unit_size가 될것이다. 또한 해당 node에서 구해와야되서 cpu를 인자로 넣는것이 보인다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">		<span style="color:#8f5902;font-style:italic">/* kmemleak tracks the percpu allocations separately */</span>
		<span style="color:#000">kmemleak_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000">areas</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">group</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>아까 할당해놨던 areas의 member에 넣는게 보인다.
areas[group 번호] -&gt; unit 으로 연결된다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">		<span style="color:#000">base</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">base</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ptr</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">areas</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">highest_group</span><span style="color:#000;font-weight:bold">])</span>
			<span style="color:#000">highest_group</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">group</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>제일 낮은 주소와 제일 높은 주소를 가진 group번호를 저장해놓는다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">max_distance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">areas</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">highest_group</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">base</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">max_distance</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">unit_size</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">groups</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">highest_group</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">nr_units</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>가장 높은 주소를 가진 group의 unit 시작주소 + 가장 높은주소의 group의 unit 크기를 더햇다.
즉 가장 아래의 unit의 시작 ~ 가장 높은 unit의 마지막 주소가 max_distacne가 된다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#8f5902;font-style:italic">/* warn if maximum distance is further than 75% of vmalloc space */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_distance</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">VMALLOC_TOTAL</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">pr_warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;max_distance=0x%lx too large for vmalloc space 0x%lx</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
				<span style="color:#000">max_distance</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">VMALLOC_TOTAL</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">#ifdef CONFIG_NEED_PER_CPU_PAGE_FIRST_CHUNK
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">/* and fail if we have fallback */</span>
		<span style="color:#000">rc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">EINVAL</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">out_free_areas</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">#endif
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * Copy data and free unused parts.  This should happen after all
</span><span style="color:#8f5902;font-style:italic">	 * allocations are complete; otherwise, we may end up with
</span><span style="color:#8f5902;font-style:italic">	 * overlapping groups.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">group</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">group</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_groups</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">group</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_group_info</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">gi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">groups</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">group</span><span style="color:#000;font-weight:bold">];</span>
		<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">areas</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">group</span><span style="color:#000;font-weight:bold">];</span>

		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">gi</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_units</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ptr</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">unit_size</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">gi</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">cpu_map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">NR_CPUS</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#8f5902;font-style:italic">/* unused unit, free whole */</span>
				<span style="color:#000">free_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">unit_size</span><span style="color:#000;font-weight:bold">);</span>
				<span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000;font-weight:bold">}</span>
			<span style="color:#8f5902;font-style:italic">/* copy and return the unused part */</span>
			<span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__per_cpu_load</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">static_size</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">free_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ptr</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">size_sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">unit_size</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">size_sum</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>이 전에서 사용하지 않은 unit은 NR_CPUS로 했었다. 해당 unit의 memory는 free를 한다. 그리고 원본 percpu 에서 static_size를 복사해오고, unit size를 넘는 부분은 free해버린다.(이전에 alloc크기가 컷다면 unit size이상 한번에 할당했었을 것이다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#8f5902;font-style:italic">/* base address is now known, determine group base offsets */</span>
	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">group</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">group</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_groups</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">group</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">groups</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">group</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">base_offset</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">areas</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">group</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">base</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>제일 아래있는 base 주소에서 현재 group unit 시작 주소의 offset을 구한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">pr_info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Embedded %zu pages/cpu s%zu r%zu d%zu u%zu</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">PFN_DOWN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">size_sum</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">static_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">reserved_size</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dyn_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">unit_size</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">pcpu_setup_first_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ai</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">base</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">out_free</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#f57900">out_free_areas</span><span style="color:#000;font-weight:bold">:</span>
	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">group</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">group</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_groups</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">group</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">areas</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">group</span><span style="color:#000;font-weight:bold">])</span>
			<span style="color:#000">free_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">areas</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">group</span><span style="color:#000;font-weight:bold">],</span>
				<span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">groups</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">group</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">nr_units</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ai</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">unit_size</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#f57900">out_free</span><span style="color:#000;font-weight:bold">:</span>
	<span style="color:#000">pcpu_free_alloc_info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ai</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">areas</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">memblock_free_early</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__pa</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">areas</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">areas_size</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rc</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#8f5902;font-style:italic">#endif </span><span style="color:#8f5902;font-style:italic">/* BUILD_EMBED_FIRST_CHUNK */</span><span style="color:#8f5902;font-style:italic">
</span></code></pre></div><p>pcpu_setup_first_chunk 전까지 unit memory를 초기화하고, 사용하지 않은 영역을 전부 free했다.</p>
<h2 id="pcpu_next_md_free_region">pcpu_next_md_free_region</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_next_md_free_region - finds the next hint free area
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @bit_off: chunk offset
</span><span style="color:#8f5902;font-style:italic"> * @bits: size of free area
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Helper function for pcpu_for_each_md_free_region.  It checks
</span><span style="color:#8f5902;font-style:italic"> * block-&gt;contig_hint and performs aggregation across blocks to find the
</span><span style="color:#8f5902;font-style:italic"> * next hint.  It modifies bit_off and bits in-place to be consumed in the
</span><span style="color:#8f5902;font-style:italic"> * loop.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_next_md_free_region</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span>
				     <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_off_to_block_index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">block_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_off_to_block_off</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">block</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">md_blocks</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">pcpu_chunk_nr_blocks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">);</span>
	     <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">/* handles contig area across blocks */</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">left_free</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">left_free</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">)</span>
				<span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>

		<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">		 * This checks three things.  First is there a contig_hint to
</span><span style="color:#8f5902;font-style:italic">		 * check.  Second, have we checked this hint before by
</span><span style="color:#8f5902;font-style:italic">		 * comparing the block_off.  Third, is this the same as the
</span><span style="color:#8f5902;font-style:italic">		 * right contig hint.  In the last case, it spills over into
</span><span style="color:#8f5902;font-style:italic">		 * the next block and should be handled by the contig area
</span><span style="color:#8f5902;font-style:italic">		 * across blocks code.
</span><span style="color:#8f5902;font-style:italic">		 */</span>
		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">block_off</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
		    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_block_off_to_off</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span>
					<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#8f5902;font-style:italic">/* reset to satisfy the second predicate above */</span>
		<span style="color:#000">block_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">right_free</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">right_free</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>bit_off 부터 시작해 free영역을 구해온다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">block_off</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
		    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_block_off_to_off</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span>
					<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>contig hint 영역을 확인한다 block_off(시작시에만 (in)bit_off에 맞게 설정되고 그다음부턴 다음 block이므로 0이됨). 보다시피 해당 block의 끝점에 contig hint가 안닿아 있는경우에만 bit_off를 contig_hint_start로 갱신해서 return 한다.</p>
<p>주석에도 나와있지만 다음과 같은 case때문이다.</p>
<pre><code>    block 1                     block2
|              (free)|(free)            |
   ^(in)bit_off  ^contig_hint_start, contig_hint가 block1의 끝까지 닿아있음
</code></pre><p>이 경우 contig_hint == right_free일 것이다. free영역이 다음 block까지 존재할수 있으니 contig hint로 return하는 if문은 치우고 그다음 right_free처리로 넘어간다</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">		<span style="color:#8f5902;font-style:italic">/* reset to satisfy the second predicate above */</span>
		<span style="color:#000">block_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">right_free</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">right_free</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><pre><code>    block 1                     block2
|                (free)|(free)            |
   ^(in)bit_off  ^(갱신)bits_off
                 ^&lt;--&gt;^ right_free 
</code></pre><p>그리고 위 case처럼 연이어서 left_free가 있는경우엔 for문 시작지점에서 체크될것이다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">left_free</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">left_free</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">)</span>
				<span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>left_free 까지 붙여서 return을 시킨다. 또한 만약 left_free가 block전체영역 size랑 같으면 결국 다음 block까지 연결되므로 continue를 하는것이 보인다.</p>
<ol>
<li>contig hint를 기준으로 검사한다. 그런데 contig hint가 right_free이면 다음 block까지 연결될것을 예상하므로 right_free를 계산하고 다음 block을 넘어간다.</li>
<li>right_free만 있는경우, left_free만 있는 경우 등등 전부 그 자체가 contig hint가 될것이므로 contig hint 처리에서 넘어갈것이다.</li>
<li>만약 블럭전체가 free size인 경우 left_free가 PCPU_BITMAP_BLOCK_BITS랑 일치하는지 확인하여 알수있으며 이 경우 다음 block까지 계속 더해간다.</li>
</ol>
<h2 id="pcpu_next_fit_region">pcpu_next_fit_region</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_next_fit_region - finds fit areas for a given allocation request
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @alloc_bits: size of allocation
</span><span style="color:#8f5902;font-style:italic"> * @align: alignment of area (max PAGE_SIZE)
</span><span style="color:#8f5902;font-style:italic"> * @bit_off: chunk offset
</span><span style="color:#8f5902;font-style:italic"> * @bits: size of free area
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Finds the next free region that is viable for use with a given size and
</span><span style="color:#8f5902;font-style:italic"> * alignment.  This only returns if there is a valid area to be used for this
</span><span style="color:#8f5902;font-style:italic"> * allocation.  block-&gt;first_free is returned if the allocation request fits
</span><span style="color:#8f5902;font-style:italic"> * within the block to see if the request can be fulfilled prior to the contig
</span><span style="color:#8f5902;font-style:italic"> * hint.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_next_fit_region</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">,</span>
				 <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">align</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_off_to_block_index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">block_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_off_to_block_off</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">block</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">md_blocks</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">pcpu_chunk_nr_blocks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">);</span>
	     <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">/* handles contig area across blocks */</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">left_free</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">)</span>
				<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">left_free</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">)</span>
				<span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>

		<span style="color:#8f5902;font-style:italic">/* check block-&gt;contig_hint */</span>
		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ALIGN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">align</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">		 * This uses the block offset to determine if this has been
</span><span style="color:#8f5902;font-style:italic">		 * checked in the prior iteration.
</span><span style="color:#8f5902;font-style:italic">		 */</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
		    <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">block_off</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
		    <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_next_hint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">);</span>

			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">alloc_bits</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">-</span>
				 <span style="color:#000">start</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_block_off_to_off</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#8f5902;font-style:italic">/* reset to satisfy the second predicate above */</span>
		<span style="color:#000">block_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ALIGN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">right_free</span><span style="color:#000;font-weight:bold">,</span>
				 <span style="color:#000">align</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_block_off_to_off</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#8f5902;font-style:italic">/* no valid offsets were found - fail condition */</span>
	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_chunk_map_bits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>pcpu_next_md_free_region 함수와 전체적인 동작은 비슷하다. 단 pcpu_next_md_free_region는 contig hint 기준으로 free size를 적당히 얻어 왔다면 이 함수는 요구사항대로가져온다.
alloc_bits 이상의 free size를 찾는데, offset을 align에 맞추는 기능이 있는게 보인다. 못찾을때는 bit_off를 end bit로 설정하는게 보인다.</p>
<h1 id="__pcpu_chunk_move">__pcpu_chunk_move</h1>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">__pcpu_chunk_move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">slot</span><span style="color:#000;font-weight:bold">,</span>
			      <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">move_front</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">pcpu_reserved_chunk</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">move_front</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#000">list_move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_chunk_lists</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">slot</span><span style="color:#000;font-weight:bold">]);</span>
		<span style="color:#204a87;font-weight:bold">else</span>
			<span style="color:#000">list_move_tail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_chunk_lists</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">slot</span><span style="color:#000;font-weight:bold">]);</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_chunk_move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">slot</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">__pcpu_chunk_move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">slot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

</code></pre></div><p>chunk를 slot번호에 해당하는 chunk_lists에 넣는다.  move_front에 따라서 앞에넣을지 뒤에 넣을지가 보인다.
slot 번호란것은 결국 size에 따라 관리할 목록 개념이다.</p>
<h2 id="pcpu_chunk_relocate">pcpu_chunk_relocate</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">pcpu_chunk_slot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk_md</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">chunk_md</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">free_bytes</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">PCPU_MIN_ALLOC_SIZE</span> <span style="color:#ce5c00;font-weight:bold">||</span>
	    <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pcpu_size_to_slot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">PCPU_MIN_ALLOC_SIZE</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_chunk_relocate - put chunk in the appropriate chunk slot
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @oslot: the previous slot it was on
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * This function is called after an allocation or free changed @chunk.
</span><span style="color:#8f5902;font-style:italic"> * New slot according to the changed state is determined and @chunk is
</span><span style="color:#8f5902;font-style:italic"> * moved to the slot.  Note that the reserved chunk is never put on
</span><span style="color:#8f5902;font-style:italic"> * chunk slots.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * CONTEXT:
</span><span style="color:#8f5902;font-style:italic"> * pcpu_lock.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_chunk_relocate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">oslot</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nslot</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_chunk_slot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#8f5902;font-style:italic">/* leave isolated chunks in-place */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">isolated</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">oslot</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">nslot</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">__pcpu_chunk_move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nslot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oslot</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nslot</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>pcpu_chunk_slot을 먼저 보면 할당이 불가능한 상태면 0, 그게 아니면 현재 contig hint의 크기로 slot번호를 만드는것이 보인다.
즉 여기서 contig hint기준으로 slot 번호가 할당된다는것을 알 수 있다.
그렇다면 결국 pcpu_chunk_relocate는 해당 contig hint에 맞는 slot으로 넣어주는 역할을 함을 알수 있게 되었다. 그런데 이전 slot과 같으면 안넣고, 만약 이전슬롯이 현재 슬롯보다 작으면 front에, 아니면 tail에 넣는게 보인다.
즉 contig size가 커졌으면 front, 작아졌으면 tail에 위치한다.</p>
<h2 id="pcpu_isolate_chunk">pcpu_isolate_chunk</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_isolate_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">lockdep_assert_held</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">isolated</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">isolated</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">pcpu_nr_empty_pop_pages</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_empty_pop_pages</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000">list_move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_chunk_lists</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pcpu_to_depopulate_slot</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>isolate란게 됬으면 depopulate slot에 들어가나 보다. 아마 일단 분리해놓는 개념인거같다.</p>
<h2 id="pcpu_reintegrate_chunk">pcpu_reintegrate_chunk</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_reintegrate_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">lockdep_assert_held</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">isolated</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">isolated</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">pcpu_nr_empty_pop_pages</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_empty_pop_pages</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">pcpu_chunk_relocate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>isolate됬던걸 다시 원복시키는건가 보다. 이전에 정규 slot에 위치하지 않았으므로 이전 슬롯이 없다는 개념으로 -1을 넣는것처럼 보인다.</p>
<h2 id="pcpu_block_update_scan">pcpu_block_update_scan</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * pcpu_block_update_scan - update a block given a free area from a scan
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @bit_off: chunk offset
</span><span style="color:#8f5902;font-style:italic"> * @bits: size of free area
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Finding the final allocation spot first goes through pcpu_find_block_fit()
</span><span style="color:#8f5902;font-style:italic"> * to find a block that can hold the allocation and then pcpu_alloc_area()
</span><span style="color:#8f5902;font-style:italic"> * where a scan is used.  When allocations require specific alignments,
</span><span style="color:#8f5902;font-style:italic"> * we can inadvertently create holes which will not be seen in the alloc
</span><span style="color:#8f5902;font-style:italic"> * or free paths.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * This takes a given free area hole and updates a block as it may change the
</span><span style="color:#8f5902;font-style:italic"> * scan_hint.  We need to scan backwards to ensure we don&#39;t miss free bits
</span><span style="color:#8f5902;font-style:italic"> * from alignment.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_block_update_scan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span>
				   <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">s_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_off_to_block_off</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">e_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">s_off</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">s_index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">l_bit</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">block</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e_off</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">s_index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_off_to_block_index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">block</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">md_blocks</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">s_index</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#8f5902;font-style:italic">/* scan backwards in case of alignment skipping free bits */</span>
	<span style="color:#000">l_bit</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_last_bit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcpu_index_alloc_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s_index</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">s_off</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">s_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s_off</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">l_bit</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">l_bit</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">pcpu_block_update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e_off</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>
<p>최종 할당 지점을 찾는 작업은 먼저 pcpu_find_block_fit()을 통해 할당을 보관할 수 있는 블록을 찾은 다음 pcpu_alloc_area()를 통해 검색이 사용됩니다. 할당에 특정 정렬이 필요한 경우 할당 경로 또는 여유 경로에서 볼 수 없는 구멍을 실수로 만들 수 있습니다.</p>
</li>
<li>
<p>이 경우 주어진 자유 영역 홀을 사용하고 scan_hint를 변경할 수 있으므로 블록을 업데이트합니다. 정렬에서 자유 비트를 놓치지 않으려면 뒤로 스캔해야 합니다.</p>
</li>
</ul>
<p>bit_off 부터 bits size만큼 free가 됬으니 해당 block의 metadata를 udpate하라는 것이다. find_last_bit를 통해서 set bit를 찾아서 해당 bit로 start bit를 고쳐서 쓴다.</p>
<h2 id="pcpu_chunk_refresh_hint">pcpu_chunk_refresh_hint</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_chunk_refresh_hint - updates metadata about a chunk
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @full_scan: if we should scan from the beginning
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Iterates over the metadata blocks to find the largest contig area.
</span><span style="color:#8f5902;font-style:italic"> * A full scan can be avoided on the allocation path as this is triggered
</span><span style="color:#8f5902;font-style:italic"> * if we broke the contig_hint.  In doing so, the scan_hint will be before
</span><span style="color:#8f5902;font-style:italic"> * the contig_hint or after if the scan_hint == contig_hint.  This cannot
</span><span style="color:#8f5902;font-style:italic"> * be prevented on freeing as we want to find the largest area possibly
</span><span style="color:#8f5902;font-style:italic"> * spanning blocks.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_chunk_refresh_hint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">full_scan</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk_md</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">chunk_md</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#8f5902;font-style:italic">/* promote scan_hint to contig_hint */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">full_scan</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">first_free</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">pcpu_for_each_md_free_region</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">pcpu_block_update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk_md</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

</code></pre></div><p>chunk metadata를 update한다. scan_hint의 쓰임새가 보인다.</p>
<h2 id="pcpu_block_update_hint_free">pcpu_block_update_hint_free</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_block_update_hint_free - updates the block hints on the free path
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @bit_off: chunk offset
</span><span style="color:#8f5902;font-style:italic"> * @bits: size of request
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Updates metadata for the allocation path.  This avoids a blind block
</span><span style="color:#8f5902;font-style:italic"> * refresh by making use of the block contig hints.  If this fails, it scans
</span><span style="color:#8f5902;font-style:italic"> * forward and backward to determine the extent of the free area.  This is
</span><span style="color:#8f5902;font-style:italic"> * capped at the boundary of blocks.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * A chunk update is triggered if a page becomes free, a block becomes free,
</span><span style="color:#8f5902;font-style:italic"> * or the free spans across blocks.  This tradeoff is to minimize iterating
</span><span style="color:#8f5902;font-style:italic"> * over the block metadata to update chunk_md-&gt;contig_hint.
</span><span style="color:#8f5902;font-style:italic"> * chunk_md-&gt;contig_hint may be off by up to a page, but it will never be more
</span><span style="color:#8f5902;font-style:italic"> * than the available space.  If the contig hint is contained in one block, it
</span><span style="color:#8f5902;font-style:italic"> * will be accurate.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_block_update_hint_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span>
					<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nr_empty_pages</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s_block</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">e_block</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">block</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">s_index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e_index</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* block indexes of the freed allocation */</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">s_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e_off</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* block offsets of the freed allocation */</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* start and end of the whole free area */</span>

	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * Calculate per block offsets.
</span><span style="color:#8f5902;font-style:italic">	 * The calculation uses an inclusive range, but the resulting offsets
</span><span style="color:#8f5902;font-style:italic">	 * are [start, end).  e_index always points to the last block in the
</span><span style="color:#8f5902;font-style:italic">	 * range.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
	<span style="color:#000">s_index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_off_to_block_index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">e_index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_off_to_block_index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">s_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_off_to_block_off</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">e_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_off_to_block_off</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">s_block</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">md_blocks</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">s_index</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">e_block</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">md_blocks</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">e_index</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><ul>
<li>
<p>할당 경로에 대한 메타데이터를 업데이트합니다. 이렇게 하면 블라인드 블록을 피할 수 있습니다.<br>
블록 콘티그 힌트를 사용하여 새로 고칩니다. 이 작업이 실패하면 앞뒤로 스캔하여 사용 가능한 영역의 범위를 확인합니다. 이것은 블록의 경계에서 제한된다.</p>
</li>
<li>
<p>페이지가 사용 가능해지거나 블록이 사용 가능해지거나 블록 간에 사용 가능한 범위가 확장되면 청크 업데이트가 트리거됩니다. 이 절충은 block 메타데이터에 대한 반복을 최소화하여 chunk_md-&gt;contig_hint를 업데이트하는 것입니다.<br>
chunk_md-&gt;contig_md는 최대 페이지까지 해제될 수 있지만 사용 가능한 공간보다 크지 않습니다. 콘티그 힌트가 한 블록에 들어있다면 정확할 것입니다.</p>
</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * Check if the freed area aligns with the block-&gt;contig_hint.
</span><span style="color:#8f5902;font-style:italic">	 * If it does, then the scan to find the beginning/end of the
</span><span style="color:#8f5902;font-style:italic">	 * larger free area can be avoided.
</span><span style="color:#8f5902;font-style:italic">	 *
</span><span style="color:#8f5902;font-style:italic">	 * start and end refer to beginning and end of the free area
</span><span style="color:#8f5902;font-style:italic">	 * within each their respective blocks.  This is not necessarily
</span><span style="color:#8f5902;font-style:italic">	 * the entire free area as it may span blocks past the beginning
</span><span style="color:#8f5902;font-style:italic">	 * or end of the block.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">s_off</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s_off</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">s_block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">s_block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">s_block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">		 * Scan backwards to find the extent of the free area.
</span><span style="color:#8f5902;font-style:italic">		 * find_last_bit returns the starting bit, so if the start bit
</span><span style="color:#8f5902;font-style:italic">		 * is returned, that means there was no last bit and the
</span><span style="color:#8f5902;font-style:italic">		 * remainder of the chunk is free.
</span><span style="color:#8f5902;font-style:italic">		 */</span>
		<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">l_bit</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_last_bit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcpu_index_alloc_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s_index</span><span style="color:#000;font-weight:bold">),</span>
					  <span style="color:#000">start</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">l_bit</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">l_bit</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>해제된 영역이 block-&gt;contig_hint와 일치하는지 확인한다.<br>
그러면 더 큰 여유 영역의 시작/끝을 찾기 위한 스캔을 피할 수 있습니다.</li>
<li>시작과 끝은 각각의 블록 내에 있는 자유 영역의 시작과 끝을 가리킨다. 이것은 블록의 시작이나 끝을 지나 블록에 걸쳐 있을 수 있기 때문에 반드시 전체 자유 영역은 아닙니다</li>
<li>뒤로 스캔하여 사용 가능한 영역의 범위를 찾습니다.<br>
find_last_bit는 시작 비트를 반환하므로 시작 비트가 반환되면 마지막 비트가 없고 청크의 나머지가 사용 가능하다는 의미입니다.</li>
</ul>
<p>s_off가 contig hint의 끝나는 부분이면 start를 contig hint start부분으로 한다. s_off가 contig hint의 끝에 위치한다는것은 결국 contig hint가 커질수있다는것을 의미하므로 start를 contig hint부터 하는것이다.
그게 아니면 alloc_map을 backward로 뒤져 alloc bit를 찾는다. 요청 size대로 return 되면 set bit가 없다는것이므로 처음부터, 그게 아니면 그 bit부터 검색을 한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">e_off</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e_off</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">e_block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">e_block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">e_block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">else</span>
		<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_next_bit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcpu_index_alloc_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e_index</span><span style="color:#000;font-weight:bold">),</span>
				    <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>contig hint start와 end가 일치하면 contig hint 끝부분까지, 그게 아니면 end 의 다음 set bit를 찾아서 end로 설정한다.
위 start를 하는것과 엮어서 봤을때 기존 contig hint의 전후로 free가 된것이므로 contig hint를 확장하기 위해 범위를 늘리기 위함임을 알 수 있다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#8f5902;font-style:italic">/* update s_block */</span>
	<span style="color:#000">e_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s_index</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">e_index</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#f57900">end</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">e_off</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">nr_empty_pages</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">pcpu_block_update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s_block</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e_off</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>end가 start block 바깥이면 당연히 start block의 끝까지 update고 그게 아니면 내부이면 내부범위 내에서 update를 수행한다. 또한 start block 전체가 free이면 empty page가 한개 생기는것이므로 관련 처리를 수항핸다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#8f5902;font-style:italic">/* freeing in the same block */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s_index</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">e_index</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">/* update e_block */</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#000">nr_empty_pages</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">pcpu_block_update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e_block</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">);</span>

		<span style="color:#8f5902;font-style:italic">/* reset md_blocks in the middle */</span>
		<span style="color:#000">nr_empty_pages</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e_index</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">s_index</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">s_block</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">block</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">e_block</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">first_free</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">left_free</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">right_free</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>end block도 바로 위의 start block처럼 처리를 하고 그 사이에있는것들은 전부 free일 것이므로 내부것들은 전부 free로 바꿔주는것이다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nr_empty_pages</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">pcpu_update_empty_pages</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nr_empty_pages</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>empty page가 있으면 metablock에 갱신해준다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * Refresh chunk metadata when the free makes a block free or spans
</span><span style="color:#8f5902;font-style:italic">	 * across blocks.  The contig_hint may be off by up to a page, but if
</span><span style="color:#8f5902;font-style:italic">	 * the contig_hint is contained in a block, it will be accurate with
</span><span style="color:#8f5902;font-style:italic">	 * the else condition below.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(((</span><span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">s_index</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">e_index</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">pcpu_chunk_refresh_hint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">else</span>
		<span style="color:#000">pcpu_block_update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">chunk_md</span><span style="color:#000;font-weight:bold">,</span>
				  <span style="color:#000">pcpu_block_off_to_off</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s_index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">),</span>
				  <span style="color:#000">end</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>start ~ end까지가 한 block size 보다 많거나 size가 작아도 중간에 걸치면 chunk를 full scan하고(그냥 s_index != e_index 만 있으면 될거같은데 왜 이런진 모르겠다) 그게 아니면 해당 block에 대한것만 chunk metablock에 update해준다.
정리를 하면 요청한 영역이 free가 됬다는것을 metadata에 update하는데 기존 contig hint와 연속되는 상황이면 해당 범위를 추가해서 metadata를 update한다.</p>
<h2 id="pcpu_is_populated">pcpu_is_populated</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_is_populated - determines if the region is populated
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @bit_off: chunk offset
</span><span style="color:#8f5902;font-style:italic"> * @bits: size of area
</span><span style="color:#8f5902;font-style:italic"> * @next_off: return value for the next offset to start searching
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * For atomic allocations, check if the backing pages are populated.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * RETURNS:
</span><span style="color:#8f5902;font-style:italic"> * Bool if the backing pages are populated.
</span><span style="color:#8f5902;font-style:italic"> * next_index is to skip over unpopulated blocks in pcpu_find_block_fit.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">pcpu_is_populated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">,</span>
			      <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">next_off</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">page_start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">page_end</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">page_start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PFN_DOWN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">PCPU_MIN_ALLOC_SIZE</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">page_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PFN_UP</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">PCPU_MIN_ALLOC_SIZE</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">page_start</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">bitmap_next_clear_region</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">populated</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">re</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">page_end</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">page_end</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">next_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">re</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">PAGE_SIZE</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">PCPU_MIN_ALLOC_SIZE</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>bit_off ~ bit_off + bits off까지의 영역이 populate 되있는지 확인한다. page align으로 맞춰서 검색하는게 보인다.</p>
<h2 id="pcpu_find_block_fit">pcpu_find_block_fit</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_find_block_fit - finds the block index to start searching
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @alloc_bits: size of request in allocation units
</span><span style="color:#8f5902;font-style:italic"> * @align: alignment of area (max PAGE_SIZE bytes)
</span><span style="color:#8f5902;font-style:italic"> * @pop_only: use populated regions only
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Given a chunk and an allocation spec, find the offset to begin searching
</span><span style="color:#8f5902;font-style:italic"> * for a free region.  This iterates over the bitmap metadata blocks to
</span><span style="color:#8f5902;font-style:italic"> * find an offset that will be guaranteed to fit the requirements.  It is
</span><span style="color:#8f5902;font-style:italic"> * not quite first fit as if the allocation does not fit in the contig hint
</span><span style="color:#8f5902;font-style:italic"> * of a block or chunk, it is skipped.  This errs on the side of caution
</span><span style="color:#8f5902;font-style:italic"> * to prevent excess iteration.  Poor alignment can cause the allocator to
</span><span style="color:#8f5902;font-style:italic"> * skip over blocks and chunks that have valid free areas.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * RETURNS:
</span><span style="color:#8f5902;font-style:italic"> * The offset in the bitmap to begin searching.
</span><span style="color:#8f5902;font-style:italic"> * -1 if no offset is found.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">pcpu_find_block_fit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">,</span>
			       <span style="color:#000">size_t</span> <span style="color:#000">align</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">pop_only</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk_md</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">chunk_md</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next_off</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * This is an optimization to prevent scanning by assuming if the
</span><span style="color:#8f5902;font-style:italic">	 * allocation cannot fit in the global hint, there is memory pressure
</span><span style="color:#8f5902;font-style:italic">	 * and creating a new chunk would happen soon.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">pcpu_check_block_hint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk_md</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">align</span><span style="color:#000;font-weight:bold">))</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_next_hint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk_md</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">pcpu_for_each_fit_region</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">align</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">pop_only</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">pcpu_is_populated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">,</span>
						   <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">next_off</span><span style="color:#000;font-weight:bold">))</span>
			<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">next_off</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">pcpu_chunk_map_bits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">))</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>
<p>청크와 할당 규격이 지정된 경우 사용 가능한 영역 검색을 시작할 오프셋을 찾습니다. 이것은 요구 사항에 맞는 오프셋을 찾기 위해 비트맵 메타데이터 블록 위에 반복한다. 할당이 블록이나 청크의 콘티그 힌트에 맞지 않는 경우 건너뜁니다. 이는 과도한 반복을 방지하기 위해 주의를 기울이는 측면이 있습니다. 제대로 정렬되지 않으면 할당자가 유효한 여유 영역이 있는 블록 및 청크를 건너뛸 수 있습니다.</p>
</li>
<li>
<p>이는 할당이 글로벌 힌트에 맞지 않을 경우 메모리 압력이 있고 곧 새 청크가 생성될 것으로 가정하여 검색을 방지하기 위한 최적화입니다.</p>
</li>
</ul>
<p>align으로 alignment 되고 alloc_bits 만큼 free 영역이 있는 bit offset을 구한다.</p>
<ol>
<li>pcpu_check_block_hint에서 지금 contig hint보다 요청 할당영역(alloc_bits)가 큰지 확인한다.  contig hint가 현재 chunk에서 가장 큰 영역이므로 이보다 큰게 요청되면 여기서 컷되고 새로운 chunk가 할당될것이다.</li>
<li>pcpu_next_hint에서 bit_off이 구해진다. 저 함수에서 scan_hint_start + scan_hint 다음영역이거나 first_free를 return한다. scan_hint보다 작은것은 first_free부터 검색을하고 scan_hint보다 큰것들은 그 다음 영역부터 검색을 한다는 개념이다. scan_hint를 기준으로 검색범위를 좁히는것을 알 수 있다.</li>
<li>그럼 이제 for문을 통해서 free 영역을 구해오는데, populate까지 검사하는게 보인다. populate를 고려 안한다면 최악조건은 contig hint에서 할당이 될것이다. 만약 contig hint가 popluate안되있고 이후에도 못찾으면 검색 실패가 되고 새로운 chunk가 할당될것이다.</li>
</ol>
<h2 id="pcpu_find_zero_area">pcpu_find_zero_area</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * pcpu_find_zero_area - modified from bitmap_find_next_zero_area_off()
</span><span style="color:#8f5902;font-style:italic"> * @map: the address to base the search on
</span><span style="color:#8f5902;font-style:italic"> * @size: the bitmap size in bits
</span><span style="color:#8f5902;font-style:italic"> * @start: the bitnumber to start searching at
</span><span style="color:#8f5902;font-style:italic"> * @nr: the number of zeroed bits we&#39;re looking for
</span><span style="color:#8f5902;font-style:italic"> * @align_mask: alignment mask for zero area
</span><span style="color:#8f5902;font-style:italic"> * @largest_off: offset of the largest area skipped
</span><span style="color:#8f5902;font-style:italic"> * @largest_bits: size of the largest area skipped
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * The @align_mask should be one less than a power of 2.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * This is a modified version of bitmap_find_next_zero_area_off() to remember
</span><span style="color:#8f5902;font-style:italic"> * the largest area that was skipped.  This is imperfect, but in general is
</span><span style="color:#8f5902;font-style:italic"> * good enough.  The largest remembered region is the largest failed region
</span><span style="color:#8f5902;font-style:italic"> * seen.  This does not include anything we possibly skipped due to alignment.
</span><span style="color:#8f5902;font-style:italic"> * pcpu_block_update_scan() does scan backwards to try and recover what was
</span><span style="color:#8f5902;font-style:italic"> * lost to alignment.  While this can cause scanning to miss earlier possible
</span><span style="color:#8f5902;font-style:italic"> * free areas, smaller allocations will eventually fill those holes.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">pcpu_find_zero_area</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span>
					 <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span>
					 <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span>
					 <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">,</span>
					 <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">align_mask</span><span style="color:#000;font-weight:bold">,</span>
					 <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_off</span><span style="color:#000;font-weight:bold">,</span>
					 <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_bits</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
</code></pre></div><ul>
<li>이것은 건너뛴 가장 큰 영역을 기억하기 위해 수정된 비트맵_find_next_zero_area_off() 버전입니다. 이것은 불완전하지만 일반적으로 충분합니다. 기억되는 가장 큰 지역은 가장 큰 실패 지역입니다. 여기에는 정렬로 인해 건너뛸 수 있는 내용이 포함되어 있지 않습니다.<br>
pcpu_block_update_scan은 뒤로 검색하여 정렬에 손실된 항목을 복구합니다. 이로 인해 스캔이 이전의 가능한 사용 가능한 영역을 놓칠 수 있지만 더 작은 할당으로 인해 결국 이러한 구멍을 채울 수 있습니다.</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">area_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">area_bits</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#f57900">again</span><span style="color:#000;font-weight:bold">:</span>
	<span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_next_zero_bit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>start ~ size 범위내에서 최초의 clear bit를 찾는다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#8f5902;font-style:italic">/* Align allocation */</span>
	<span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__ALIGN_MASK</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">align_mask</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">area_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>요구사항대로 align시킨다. 만약 map의 범위를 넘어서면 그냥 end를 return하는것이 보인다. size보다 크면 error라고 보면될듯싶다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_next_bit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">area_bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">area_off</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#8f5902;font-style:italic">/* remember largest unused area with best alignment */</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">area_bits</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_bits</span> <span style="color:#ce5c00;font-weight:bold">||</span>
		    <span style="color:#000;font-weight:bold">(</span><span style="color:#000">area_bits</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_bits</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_off</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
		     <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">area_off</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">__ffs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">area_off</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">__ffs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_off</span><span style="color:#000;font-weight:bold">))))</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">area_off</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">area_bits</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>

		<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">again</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><pre><code>ex) nr이 9개라고 했고 bitmap이 아래 그림과 같을때
11111111110000000011111111000000000011111..

1회차               v end
11111111110000000011111111000000000011111..
^start    ^index  ^i

i &lt; end 이므로 agin된다. largest_off와 largest_bits에는 pass된 free영역이 저장될것이다.
이후에 가장 큰 free 영역으로만 갱신한다.
만약 기존 largest 영역과 현재 pass하는 영역의 크기가 같으면 더 정렬이 잘된것을 기준으로 갱신한다.

2회차
 largest_off
          v                       v end
11111111110000000011111111000000000011111..
          &lt;------&gt; ^start ^index    ^i
          largest_bits
i &gt; end이므로 조건에 맞게되 index를 return한다.
</code></pre><p>즉 start부터 nr개만큼의 free size가 있는 index를 return하면서 중간에 pass하는 free area중에 가장 큰 area의 start와 size까지 return하는 기능을 수행한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * pcpu_find_zero_area - modified from bitmap_find_next_zero_area_off()
</span><span style="color:#8f5902;font-style:italic"> * @map: the address to base the search on
</span><span style="color:#8f5902;font-style:italic"> * @size: the bitmap size in bits
</span><span style="color:#8f5902;font-style:italic"> * @start: the bitnumber to start searching at
</span><span style="color:#8f5902;font-style:italic"> * @nr: the number of zeroed bits we&#39;re looking for
</span><span style="color:#8f5902;font-style:italic"> * @align_mask: alignment mask for zero area
</span><span style="color:#8f5902;font-style:italic"> * @largest_off: offset of the largest area skipped
</span><span style="color:#8f5902;font-style:italic"> * @largest_bits: size of the largest area skipped
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * The @align_mask should be one less than a power of 2.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * This is a modified version of bitmap_find_next_zero_area_off() to remember
</span><span style="color:#8f5902;font-style:italic"> * the largest area that was skipped.  This is imperfect, but in general is
</span><span style="color:#8f5902;font-style:italic"> * good enough.  The largest remembered region is the largest failed region
</span><span style="color:#8f5902;font-style:italic"> * seen.  This does not include anything we possibly skipped due to alignment.
</span><span style="color:#8f5902;font-style:italic"> * pcpu_block_update_scan() does scan backwards to try and recover what was
</span><span style="color:#8f5902;font-style:italic"> * lost to alignment.  While this can cause scanning to miss earlier possible
</span><span style="color:#8f5902;font-style:italic"> * free areas, smaller allocations will eventually fill those holes.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">pcpu_find_zero_area</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span>
					 <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span>
					 <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span>
					 <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">,</span>
					 <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">align_mask</span><span style="color:#000;font-weight:bold">,</span>
					 <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_off</span><span style="color:#000;font-weight:bold">,</span>
					 <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_bits</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">area_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">area_bits</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#f57900">again</span><span style="color:#000;font-weight:bold">:</span>
	<span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_next_zero_bit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#8f5902;font-style:italic">/* Align allocation */</span>
	<span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__ALIGN_MASK</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">align_mask</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">area_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_next_bit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">area_bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">area_off</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#8f5902;font-style:italic">/* remember largest unused area with best alignment */</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">area_bits</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_bits</span> <span style="color:#ce5c00;font-weight:bold">||</span>
		    <span style="color:#000;font-weight:bold">(</span><span style="color:#000">area_bits</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_bits</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_off</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
		     <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">area_off</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">__ffs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">area_off</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">__ffs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_off</span><span style="color:#000;font-weight:bold">))))</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">area_off</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">largest_bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">area_bits</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>

		<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">again</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="pcpu_alloc_area">pcpu_alloc_area</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_alloc_area - allocates an area from a pcpu_chunk
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @alloc_bits: size of request in allocation units
</span><span style="color:#8f5902;font-style:italic"> * @align: alignment of area (max PAGE_SIZE)
</span><span style="color:#8f5902;font-style:italic"> * @start: bit_off to start searching
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * This function takes in a @start offset to begin searching to fit an
</span><span style="color:#8f5902;font-style:italic"> * allocation of @alloc_bits with alignment @align.  It needs to scan
</span><span style="color:#8f5902;font-style:italic"> * the allocation map because if it fits within the block&#39;s contig hint,
</span><span style="color:#8f5902;font-style:italic"> * @start will be block-&gt;first_free. This is an attempt to fill the
</span><span style="color:#8f5902;font-style:italic"> * allocation prior to breaking the contig hint.  The allocation and
</span><span style="color:#8f5902;font-style:italic"> * boundary maps are updated accordingly if it confirms a valid
</span><span style="color:#8f5902;font-style:italic"> * free area.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * RETURNS:
</span><span style="color:#8f5902;font-style:italic"> * Allocated addr offset in @chunk on success.
</span><span style="color:#8f5902;font-style:italic"> * -1 if no matching area is found.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">pcpu_alloc_area</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">,</span>
			   <span style="color:#000">size_t</span> <span style="color:#000">align</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk_md</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">chunk_md</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">size_t</span> <span style="color:#000">align_mask</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">align</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">align</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">area_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">area_bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oslot</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">lockdep_assert_held</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><ul>
<li>이 함수는 @start 오프셋을 사용하여 @alloc_bits 할당을 @align에 맞추기 위한 검색을 시작합니다. 블록의 콘티그 힌트 내에 @start가 block-&gt;first_free가 되기 때문에 할당 맵을 스캔해야 한다. 콘티그 힌트를 깨기 전에 할당을 채우려는 시도입니다. 할당 및 경계 지도는 유효한 사용 가능 영역을 확인하는 경우 그에 따라 업데이트됩니다.</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">oslot</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_chunk_slot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * Search to find a fit.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
	<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">min_t</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">alloc_bits</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">,</span>
		    <span style="color:#000">pcpu_chunk_map_bits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">));</span>
	<span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_find_zero_area</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">alloc_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">,</span>
				      <span style="color:#000">align_mask</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">area_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">area_bits</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>end를 alloc_bits보다 한 lobkc더 여유있게 잡는것이 보인다. 해당 범위에서 free area를 찾지 못하면 실패처리된다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">area_bits</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">pcpu_block_update_scan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">area_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">area_bits</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>pcpu_find_zero_area을 보면서 pass했던 영역을 어떻게 하나 봤더만 chunk에 metadata를 update하는데 사용하는것이 보인다. skip area가 contig hint보다 클일은 없을거 같다.
pcpu_block_update에서 scan hint가 없어지는 상황이나 alloc 영역이 겹쳐서 scan hint가 없어지는 상황등, 즉 scan hint가 없는상황이 있는데 이런 경우 여기서 scan hint가 새로 생길것이다. 아니면 또 이함수를 보건데 scan hint가 무조건 contig hint의 다음 free size를 가지고 있을거 같지도 않다. 즉 alloc을 하면서 skip한 area중에 제일 큰 area가 scan hint로 갱신될 기회를 가진다고 보면될거같다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#8f5902;font-style:italic">/* update alloc map */</span>
	<span style="color:#000">bitmap_set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">alloc_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>실제 할당이 됬다는 표식을 수행한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#8f5902;font-style:italic">/* update boundary map */</span>
	<span style="color:#000">set_bit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">bound_map</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">bitmap_clear</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">bound_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">alloc_bits</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">set_bit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">bound_map</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>biit_off ~ bit_off + alloc_bits까지는 할당이 되었다. 경계점을 bound_map에 표시한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">free_bytes</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#000">alloc_bits</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">PCPU_MIN_ALLOC_SIZE</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#8f5902;font-style:italic">/* update first free bit */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">first_free</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">first_free</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_next_zero_bit</span><span style="color:#000;font-weight:bold">(</span>
					<span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">alloc_map</span><span style="color:#000;font-weight:bold">,</span>
					<span style="color:#000">pcpu_chunk_map_bits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">),</span>
					<span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>bit_off가 first_free랑 같다는것은 first_free영역부터 할당을 했다는것이므로 할당이후 최초의 free 지점으로 first_free를 갱신해야된다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">pcpu_block_update_hint_alloc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">pcpu_chunk_relocate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oslot</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">PCPU_MIN_ALLOC_SIZE</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>alloc후 metadata를 update해주고 slot에 넣어버린다.</p>
<ol>
<li>(align을 수행한)start부터 alloc_bits size를 할당한다.</li>
<li>alloc도중 free size가 모잘라 넘어간 영역중에 제일 큰 영역은 metadata에 갱신을 시도한다. 여기서 scan hint나 contig hint가 갱신될수 있을것이다.</li>
<li>실제 alloc_map에 할당표시를 하고 bound_map에도 경계를 표시한다.</li>
<li>first_free를 필요에 따라 갱신한다.</li>
<li>chunk 전체 영역에 대해서 metada update를 수행하고 갱신된 contig hint를 기준으로 해당 slot으로 들어갈것이다.</li>
</ol>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">pcpu_block_refresh_hint, pcpu_block_update_scan, pcpu_block_update_hint_alloc에 대한 비교 중간정리</h4>

    <ul>
<li>pcpu_block_update_scan : 요구한 영역은 free area이며 그걸 기준으로 chunk metadata를 갱신한다.</li>
<li>pcpu_block_update_hint_alloc : 요구한 영역은 alloc area며 현재 chunk metadata와 영역이 겹치는 확인해서 겹친다면 metadata refresh를 수행한다. 또한 block medadata또한 갱신된다.</li>
<li>pcpu_chunk_refresh_hint : metadata refresh를 수행한다. 가지고있는 metada를 기준으로 시작을 한다.</li>
</ul>

</div>

<h2 id="pcpu_free_area">pcpu_free_area</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_free_area - frees the corresponding offset
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @off: addr offset into chunk
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * This function determines the size of an allocation to free using
</span><span style="color:#8f5902;font-style:italic"> * the boundary bitmap and clears the allocation map.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * RETURNS:
</span><span style="color:#8f5902;font-style:italic"> * Number of freed bytes.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">pcpu_free_area</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">off</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk_md</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">chunk_md</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oslot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">freed</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">lockdep_assert_held</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">pcpu_stats_area_dealloc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">oslot</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_chunk_slot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">off</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">PCPU_MIN_ALLOC_SIZE</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#8f5902;font-style:italic">/* find end index */</span>
	<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_next_bit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">bound_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pcpu_chunk_map_bits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">),</span>
			    <span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">bitmap_clear</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">alloc_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">freed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">PCPU_MIN_ALLOC_SIZE</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#8f5902;font-style:italic">/* update metadata */</span>
	<span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">free_bytes</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">freed</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#8f5902;font-style:italic">/* update first free bit */</span>
	<span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">first_free</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">first_free</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">pcpu_block_update_hint_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">pcpu_chunk_relocate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oslot</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">freed</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>해당 offset을 시작점으로 free를 한다. bound_map의 set bit를 통해서 해당 map이 어디까지 alloc이 됬는지 확인을 하고 alloc_map을 clear시켜버리는게 보인다. alloc_map을 clear후에는 first_free를 갱신하고 metada를 update한다.</p>
<h2 id="pcpu_alloc">pcpu_alloc</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_alloc - the percpu allocator
</span><span style="color:#8f5902;font-style:italic"> * @size: size of area to allocate in bytes
</span><span style="color:#8f5902;font-style:italic"> * @align: alignment of area (max PAGE_SIZE)
</span><span style="color:#8f5902;font-style:italic"> * @reserved: allocate from the reserved chunk if available
</span><span style="color:#8f5902;font-style:italic"> * @gfp: allocation flags
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Allocate percpu area of @size bytes aligned at @align.  If @gfp doesn&#39;t
</span><span style="color:#8f5902;font-style:italic"> * contain %GFP_KERNEL, the allocation is atomic. If @gfp has __GFP_NOWARN
</span><span style="color:#8f5902;font-style:italic"> * then no warning will be triggered on invalid or failed allocation
</span><span style="color:#8f5902;font-style:italic"> * requests.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * RETURNS:
</span><span style="color:#8f5902;font-style:italic"> * Percpu pointer to the allocated area on success, NULL on failure.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">__percpu</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pcpu_alloc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">align</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">reserved</span><span style="color:#000;font-weight:bold">,</span>
				 <span style="color:#000">gfp_t</span> <span style="color:#000">gfp</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">gfp_t</span> <span style="color:#000">pcpu_gfp</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">is_atomic</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">do_warn</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">obj_cgroup</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">objcg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">warn_limit</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">next</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">slot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">__percpu</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">size_t</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_align</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">gfp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">current_gfp_context</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gfp</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#8f5902;font-style:italic">/* whitelisted flags that can be passed to the backing allocators */</span>
	<span style="color:#000">pcpu_gfp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gfp</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">GFP_KERNEL</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">__GFP_NORETRY</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">__GFP_NOWARN</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">is_atomic</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">gfp</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">GFP_KERNEL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">GFP_KERNEL</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">do_warn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gfp</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">__GFP_NOWARN</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * There is now a minimum allocation size of PCPU_MIN_ALLOC_SIZE,
</span><span style="color:#8f5902;font-style:italic">	 * therefore alignment must be a minimum of that many bytes.
</span><span style="color:#8f5902;font-style:italic">	 * An allocation may have internal fragmentation from rounding up
</span><span style="color:#8f5902;font-style:italic">	 * of up to PCPU_MIN_ALLOC_SIZE - 1 bytes.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">unlikely</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">align</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">PCPU_MIN_ALLOC_SIZE</span><span style="color:#000;font-weight:bold">))</span>
		<span style="color:#000">align</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PCPU_MIN_ALLOC_SIZE</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ALIGN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PCPU_MIN_ALLOC_SIZE</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">PCPU_MIN_ALLOC_SHIFT</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">bit_align</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">align</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">PCPU_MIN_ALLOC_SHIFT</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">unlikely</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">PCPU_MIN_UNIT_SIZE</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">align</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">PAGE_SIZE</span> <span style="color:#ce5c00;font-weight:bold">||</span>
		     <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is_power_of_2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">align</span><span style="color:#000;font-weight:bold">)))</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">WARN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">do_warn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;illegal size (%zu) or align (%zu) for percpu allocation</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
		     <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">align</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">unlikely</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">pcpu_memcg_pre_alloc_hook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gfp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">objcg</span><span style="color:#000;font-weight:bold">)))</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is_atomic</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">		 * pcpu_balance_workfn() allocates memory under this mutex,
</span><span style="color:#8f5902;font-style:italic">		 * and it may wait for memory reclaim. Allow current task
</span><span style="color:#8f5902;font-style:italic">		 * to become OOM victim, in case of memory pressure.
</span><span style="color:#8f5902;font-style:italic">		 */</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">gfp</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">__GFP_NOFAIL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">mutex_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_alloc_mutex</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">mutex_lock_killable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_alloc_mutex</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">pcpu_memcg_post_alloc_hook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">objcg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>pcpu단위로 맞추는게 보인다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">spin_lock_irqsave</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#8f5902;font-style:italic">/* serve reserved allocations from the reserved chunk if available */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">reserved</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">pcpu_reserved_chunk</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">chunk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_reserved_chunk</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#000">off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_find_block_fit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_align</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">is_atomic</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">off</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;alloc from reserved chunk failed&#34;</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">fail_unlock</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>

		<span style="color:#000">off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_alloc_area</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_align</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">off</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">off</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">area_found</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;alloc from reserved chunk failed&#34;</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">fail_unlock</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>populate 된거랑 atomic이랑 무슨상관이 있는지 모르겠는데 is_atomic == populate block만 가져오라는것인가 보다.
요청한 범위의 블록이 있는지확인(pcpu_find_block_fit) -&gt; 실제 요청한곳으로 alloc수행(pcpu_alloc_area) 임이 보인다.
reseved가 아니거나 reseved chunk가 없으면 if문을 안타고 다음으로 넘어간다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f57900">restart</span><span style="color:#000;font-weight:bold">:</span>
	<span style="color:#8f5902;font-style:italic">/* search through normal chunks */</span>
	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">slot</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_size_to_slot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">slot</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">pcpu_free_slot</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">slot</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">list_for_each_entry_safe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_chunk_lists</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">slot</span><span style="color:#000;font-weight:bold">],</span>
					 <span style="color:#000">list</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_find_block_fit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_align</span><span style="color:#000;font-weight:bold">,</span>
						  <span style="color:#000">is_atomic</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">off</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">slot</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">PCPU_SLOT_FAIL_THRESHOLD</span><span style="color:#000;font-weight:bold">)</span>
					<span style="color:#000">pcpu_chunk_move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
				<span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000;font-weight:bold">}</span>

			<span style="color:#000">off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_alloc_area</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_align</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">off</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">off</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#000">pcpu_reintegrate_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">);</span>
				<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">area_found</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#000">spin_unlock_irqrestore</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>요청한 size에 해당하는 slot에서 빼고, 없으면 더 큰 size의 slot에서 할당할수있는 chunk를 찾는것이 보인다. 일반 chunk에서는 성공하면 isolate를 풀어주는게 보인다. 왜이런지는 모른다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * No space left.  Create a new chunk.  We don&#39;t want multiple
</span><span style="color:#8f5902;font-style:italic">	 * tasks to create chunks simultaneously.  Serialize and create iff
</span><span style="color:#8f5902;font-style:italic">	 * there&#39;s still no empty chunk after grabbing the mutex.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">is_atomic</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;atomic alloc failed, no space left&#34;</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">fail</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>빈자리가 없다. 새 청크를 만듭니다. 우리는 여러 작업이 동시에 청크를 생성하는 것을 원하지 않습니다. 뮤텍스를 잡은 후에도 여전히 빈 청크가 없으면 직렬화하고 만듭니다.</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">list_empty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_chunk_lists</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pcpu_free_slot</span><span style="color:#000;font-weight:bold">]))</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">chunk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_create_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcpu_gfp</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;failed to allocate new chunk&#34;</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">fail</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>

		<span style="color:#000">spin_lock_irqsave</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000">pcpu_chunk_relocate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">spin_lock_irqsave</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">restart</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>free slot에서 free chunk가 있는지 확인하고 없으면 새로만든다. 저 slot이 free chunk를 넣어둘수있나보다. 어쨋든 chunk를 얻어오면 restart부터 다시 시작해 결국 할당에 성공하면 area_found로 올것이다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f57900">area_found</span><span style="color:#000;font-weight:bold">:</span>
	<span style="color:#000">pcpu_stats_area_alloc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">spin_unlock_irqrestore</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#8f5902;font-style:italic">/* populate if not all pages are already there */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is_atomic</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">page_start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">page_end</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#000">page_start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PFN_DOWN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">off</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000">page_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PFN_UP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">off</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>

		<span style="color:#000">bitmap_for_each_clear_region</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">populated</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">,</span>
					     <span style="color:#000">page_start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">page_end</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">WARN_ON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">immutable</span><span style="color:#000;font-weight:bold">);</span>

			<span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_populate_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pcpu_gfp</span><span style="color:#000;font-weight:bold">);</span>

			<span style="color:#000">spin_lock_irqsave</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#000">pcpu_free_area</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">off</span><span style="color:#000;font-weight:bold">);</span>
				<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;failed to populate&#34;</span><span style="color:#000;font-weight:bold">;</span>
				<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">fail_unlock</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000;font-weight:bold">}</span>
			<span style="color:#000">pcpu_chunk_populated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">spin_unlock_irqrestore</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000;font-weight:bold">}</span>

		<span style="color:#000">mutex_unlock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_alloc_mutex</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>위에서 is_atomic == populate로 취급했던걸 봤다. pcpu_populate_chunk에서 몬가가 일어나고 있는데 잘모르겠다.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">populate?</h4>

    <a href="http://jake.dothome.co.kr/per-cpu/#:~:text=Demand%20Paging%20(%ED%8E%98%EC%9D%B4%EC%A7%80%EB%B3%84%20Population)">문c블로그 per cpu</a>
vm에 할당되는 영역을 populate라고 하나보다.

</div>

<p>어쨋든 mutex걸었던 이유가 조금 보이는거 같은데 pcpu_popluate_chunk에서처럼 struct page를 뭘 어떻게하면 저렇게 mutex를 걸어야되고(non atomic) 이걸 populate하지 않는다고 하나보다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcpu_nr_empty_pop_pages</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">PCPU_EMPTY_POP_PAGES_LOW</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">pcpu_schedule_balance_work</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>page가 부족하면 balance work란걸 한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#8f5902;font-style:italic">/* clear the areas and return address relative to base address */</span>
	<span style="color:#000">for_each_possible_cpu</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">memset</span><span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">pcpu_chunk_addr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>해당 chunk의 base_offset 의 cpu별 off에 size만큼 할당이 완료 되었다. 모든 cpu에 대해서 해당 memory를 0로 초기화해준다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__addr_to_pcpu_ptr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">base_addr</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">off</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">kmemleak_alloc_percpu</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gfp</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">trace_percpu_alloc_percpu</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reserved</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">is_atomic</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">align</span><span style="color:#000;font-weight:bold">,</span>
			<span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">base_addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">pcpu_memcg_post_alloc_hook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">objcg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#f57900">fail_unlock</span><span style="color:#000;font-weight:bold">:</span>
	<span style="color:#000">spin_unlock_irqrestore</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#f57900">fail</span><span style="color:#000;font-weight:bold">:</span>
	<span style="color:#000">trace_percpu_alloc_percpu_fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reserved</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">is_atomic</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">align</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is_atomic</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">do_warn</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">warn_limit</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">pr_warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;allocation failed, size=%zu align=%zu atomic=%d, %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
			<span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">align</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">is_atomic</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000">dump_stack</span><span style="color:#000;font-weight:bold">();</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!--</span><span style="color:#000">warn_limit</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#000">pr_info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;limit reached, disable warning</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">is_atomic</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">/* see the flag handling in pcpu_balance_workfn() */</span>
		<span style="color:#000">pcpu_atomic_alloc_failed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">pcpu_schedule_balance_work</span><span style="color:#000;font-weight:bold">();</span>
	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">mutex_unlock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_alloc_mutex</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#000">pcpu_memcg_post_alloc_hook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">objcg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>기타 error 처리랑 마무리.</p>
<p>pcpu_schedule_balance_work 가 수행되면 결국 pcpu_balance_workfn 가 한번 수행되는거 같다.</p>
<h1 id="balance-관련">balance 관련</h1>
<h2 id="pcpu_schedule_balance_work">pcpu_schedule_balance_work</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * Balance work is used to populate or destroy chunks asynchronously.  We
</span><span style="color:#8f5902;font-style:italic"> * try to keep the number of populated free pages between
</span><span style="color:#8f5902;font-style:italic"> * PCPU_EMPTY_POP_PAGES_LOW and HIGH for atomic allocations and at most one
</span><span style="color:#8f5902;font-style:italic"> * empty chunk.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_balance_workfn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">work_struct</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">work</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">DECLARE_WORK</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcpu_balance_work</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pcpu_balance_workfn</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">pcpu_async_enabled</span> <span style="color:#000">__read_mostly</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">pcpu_atomic_alloc_failed</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_schedule_balance_work</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcpu_async_enabled</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">schedule_work</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_balance_work</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>균형 작업은 청크를 비동기적으로 채우거나 파괴하는 데 사용됩니다. 원자량 할당을 위해 PCPU_EMPUTY_POP_PAGES_LOW와 HIGH 사이에 채워진 사용 가능한 페이지 수를 유지하고 최대 하나의 빈 청크를 유지하려고 합니다.</li>
</ul>
<p>pcpu_async_enabled를 먼저 본다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * Percpu allocator is initialized early during boot when neither slab or
</span><span style="color:#8f5902;font-style:italic"> * workqueue is available.  Plug async management until everything is up
</span><span style="color:#8f5902;font-style:italic"> * and running.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">__init</span> <span style="color:#000">percpu_enable_async</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">pcpu_async_enabled</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000">subsys_initcall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">percpu_enable_async</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>subsys_initcall 참고 : <a href="http://jake.dothome.co.kr/do_initcalls/">http://jake.dothome.co.kr/do_initcalls/</a>
subsys_initcall은 do_initcalls에서 순서대로 호출한다. 아마 거기서 저함수가 호출되서 true로 되나보다.</p>
<p>어쨋든 do_initcalls를 하고난후에 저 함수가 동작을 할거라는것을 알았다. schedule_wrok는 대충 pcpu_balance_work에 등록된 함수(pcpu_balance_workfn)를 실행시킨다 정도로만 파악하고 pcpu_balance_workfn를 보도록한다.</p>
<h2 id="pcpu_balance_workfn">pcpu_balance_workfn</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_balance_workfn - manage the amount of free chunks and populated pages
</span><span style="color:#8f5902;font-style:italic"> * @work: unused
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * For each chunk type, manage the number of fully free chunks and the number of
</span><span style="color:#8f5902;font-style:italic"> * populated pages.  An important thing to consider is when pages are freed and
</span><span style="color:#8f5902;font-style:italic"> * how they contribute to the global counts.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_balance_workfn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">work_struct</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">work</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * pcpu_balance_free() is called twice because the first time we may
</span><span style="color:#8f5902;font-style:italic">	 * trim pages in the active pcpu_nr_empty_pop_pages which may cause us
</span><span style="color:#8f5902;font-style:italic">	 * to grow other chunks.  This then gives pcpu_reclaim_populated() time
</span><span style="color:#8f5902;font-style:italic">	 * to move fully free chunks to the active list to be freed if
</span><span style="color:#8f5902;font-style:italic">	 * appropriate.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
	<span style="color:#000">mutex_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_alloc_mutex</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">spin_lock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">pcpu_balance_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">pcpu_reclaim_populated</span><span style="color:#000;font-weight:bold">();</span>
	<span style="color:#000">pcpu_balance_populated</span><span style="color:#000;font-weight:bold">();</span>
	<span style="color:#000">pcpu_balance_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">spin_unlock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">mutex_unlock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_alloc_mutex</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>각 청크 유형에 대해 사용 가능한 완전 청크 수와 채워진 페이지 수를 관리합니다. 고려해야 할 중요한 사항은 페이지가 해제되는 시점과 해당 페이지가 글로벌 카운트에 어떻게 기여하느냐입니다.</li>
<li>pcpu_balance_freefiles는 두 번 호출되는데, 이는 첫호출에서 active pcpu_balance_empty_pop_page에서 페이지를 자르면 다른 덩어리가 커질 수 있기 때문이다. 그러면 pcpu_reclaim_populated()가 완전히 사용 가능한 chunk를 사용 가능한 active list로 이동하여 적절한 경우 해제할 수 있는 시간을 줍니다.</li>
</ul>
<p>주석내용대로만 파악하고 넘어간다.</p>
<h2 id="pcpu_balance_free">pcpu_balance_free</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_balance_free - manage the amount of free chunks
</span><span style="color:#8f5902;font-style:italic"> * @empty_only: free chunks only if there are no populated pages
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * If empty_only is %false, reclaim all fully free chunks regardless of the
</span><span style="color:#8f5902;font-style:italic"> * number of populated pages.  Otherwise, only reclaim chunks that have no
</span><span style="color:#8f5902;font-style:italic"> * populated pages.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * CONTEXT:
</span><span style="color:#8f5902;font-style:italic"> * pcpu_lock (can be dropped temporarily)
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_balance_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">empty_only</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">LIST_HEAD</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">to_free</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">list_head</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">free_head</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_chunk_lists</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pcpu_free_slot</span><span style="color:#000;font-weight:bold">];</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">next</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><ul>
<li>여유 청크의 양을 관리합니다</li>
<li>empty_only가 %false이면 채워진 페이지 수에 관계없이 사용 가능한 모든 청크를 회수하십시오. 그렇지 않으면 페이지가 채워지지 않은 청크만 회수하십시오.</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">lockdep_assert_held</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * There&#39;s no reason to keep around multiple unused chunks and VM
</span><span style="color:#8f5902;font-style:italic">	 * areas can be scarce.  Destroy all free chunks except for one.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
	<span style="color:#000">list_for_each_entry_safe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">free_head</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">WARN_ON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">immutable</span><span style="color:#000;font-weight:bold">);</span>

		<span style="color:#8f5902;font-style:italic">/* spare the first one */</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">list_first_entry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">free_head</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">))</span>
			<span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">empty_only</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_empty_pop_pages</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#000">list_move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">to_free</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000;font-weight:bold">}</span>
	
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">list_empty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">to_free</span><span style="color:#000;font-weight:bold">))</span>
		<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>	
		
	<span style="color:#000">spin_unlock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>free slot을 iterate한다. 최초한개는 남겨둔다. 빈free chunk가 한개이하면 끝낸다. empty_only이면 populate가 전부 되있는 경우에만 수행하고 아니면 무조건 수행한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">list_for_each_entry_safe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">to_free</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#000">bitmap_for_each_set_region</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">populated</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
					   <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_pages</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">pcpu_depopulate_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">spin_lock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">pcpu_chunk_depopulated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">spin_unlock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#000">pcpu_destroy_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000">cond_resched</span><span style="color:#000;font-weight:bold">();</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000">spin_lock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>chunk마다 populate인 bit범위를 찾고 해당 범위를 depopulate시킨다. 그리고 chunk를 해제해버린다. depopulate방법은 자세히 안본다 percpu-vm 에 대한 이해가 아직 전혀 없기 때문이다.</p>
<h2 id="pcpu_reclaim_populated">pcpu_reclaim_populated</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_reclaim_populated - scan over to_depopulate chunks and free empty pages
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Scan over chunks in the depopulate list and try to release unused populated
</span><span style="color:#8f5902;font-style:italic"> * pages back to the system.  Depopulated chunks are sidelined to prevent
</span><span style="color:#8f5902;font-style:italic"> * repopulating these pages unless required.  Fully free chunks are reintegrated
</span><span style="color:#8f5902;font-style:italic"> * and freed accordingly (1 is kept around).  If we drop below the empty
</span><span style="color:#8f5902;font-style:italic"> * populated pages threshold, reintegrate the chunk if it has empty free pages.
</span><span style="color:#8f5902;font-style:italic"> * Each chunk is scanned in the reverse order to keep populated pages close to
</span><span style="color:#8f5902;font-style:italic"> * the beginning of the chunk.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * CONTEXT:
</span><span style="color:#8f5902;font-style:italic"> * pcpu_lock (can be dropped temporarily)
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_reclaim_populated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">block</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">freed_page_start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">freed_page_end</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">reintegrate</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><ul>
<li>청크를 추출하기 위해 스캔하고 빈 페이지를 비웁니다.</li>
<li>채워지지 않은 목록의 청크를 검색하고 채워지지 않은 페이지를 시스템에 다시 릴리스해 보십시오. 필요하지 않은 경우 이러한 페이지를 다시 채우는 것을 방지하기 위해 채워지지 않은 청크는 따로 분리된다. 완전히 자유로운 청크는 그에 따라 다시 통합되고 해제된다(1은 주변에 유지된다). 비어 있는 페이지 임계값 아래로 떨어지면 사용 가능한 페이지가 비어 있으면 청크를 다시 통합합니다.</li>
<li>각 청크는 역순으로 스캔되어 채워진 페이지를 청크의 시작 부분에 가깝게 유지합니다.</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">lockdep_assert_held</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * Once a chunk is isolated to the to_depopulate list, the chunk is no
</span><span style="color:#8f5902;font-style:italic">	 * longer discoverable to allocations whom may populate pages.  The only
</span><span style="color:#8f5902;font-style:italic">	 * other accessor is the free path which only returns area back to the
</span><span style="color:#8f5902;font-style:italic">	 * allocator not touching the populated bitmap.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
	<span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">list_empty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_chunk_lists</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pcpu_to_depopulate_slot</span><span style="color:#000;font-weight:bold">]))</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">chunk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">list_first_entry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_chunk_lists</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pcpu_to_depopulate_slot</span><span style="color:#000;font-weight:bold">],</span>
					 <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000">WARN_ON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">immutable</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><ul>
<li>청크가 to_depopulate 목록으로 분리되면 페이지를 채울 수 있는 할당에서는 더 이상 청크를 검색할 수 없습니다. 유일한 다른 접근자는 채워진 비트맵을 건드리지 않는 할당자에게만 영역을 반환하는 자유 경로이다.</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">		<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">		 * Scan chunk&#39;s pages in the reverse order to keep populated
</span><span style="color:#8f5902;font-style:italic">		 * pages close to the beginning of the chunk.
</span><span style="color:#8f5902;font-style:italic">		 */</span>
		<span style="color:#000">freed_page_start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_pages</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">freed_page_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">reintegrate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_pages</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#8f5902;font-style:italic">/* no more work to do */</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_empty_pop_pages</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
				<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>

			<span style="color:#8f5902;font-style:italic">/* reintegrate chunk to prevent atomic alloc failures */</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcpu_nr_empty_pop_pages</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">PCPU_EMPTY_POP_PAGES_HIGH</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#000">reintegrate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">;</span>
				<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">end_chunk</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000;font-weight:bold">}</span>

			<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">			 * If the page is empty and populated, start or
</span><span style="color:#8f5902;font-style:italic">			 * extend the (i, end) range.  If i == 0, decrease
</span><span style="color:#8f5902;font-style:italic">			 * i and perform the depopulation to cover the last
</span><span style="color:#8f5902;font-style:italic">			 * (first) page in the chunk.
</span><span style="color:#8f5902;font-style:italic">			 */</span>
			<span style="color:#000">block</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">md_blocks</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
			    <span style="color:#000">test_bit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">populated</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
					<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
					<span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
				<span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>페이지가 비어 있고 채워진 경우, (i, 끝) 범위를 시작하거나 확장하십시오. i == 0이면 i를 줄이고 디포퍼레이션을 수행하여 청크의 마지막 (첫 번째) 페이지를 덮습니다.</li>
</ul>
<p>시스템 전체의 populate가 부족하면 그냥 reintegrate 하러간다. alloc 할당 요청시 실패를 방지하기 위함이다. 그게 아니면 backward로 범위를 특정하는데 contig hint가 전 영역이고 chunk가 populate되있다면 한번에 하기위해 end 를 설정하고 back page로 가는게 보인다.</p>
<pre><code>                                                            nr_pages -1
block별 contig hint size : | ... |    1 | 1024 | 1024 | 1 | ... |             |
                                     ^i            ^end    
                                      &lt;------------------------- backward 방향으로 진행

</code></pre><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
			<span style="color:#8f5902;font-style:italic">/* depopulate if there is an active range */</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
				<span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>

			<span style="color:#000">spin_unlock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">pcpu_depopulate_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">cond_resched</span><span style="color:#000;font-weight:bold">();</span>
			<span style="color:#000">spin_lock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>

			<span style="color:#000">pcpu_chunk_depopulated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">freed_page_start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">freed_page_start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">freed_page_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">freed_page_end</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>

			<span style="color:#8f5902;font-style:italic">/* reset the range and continue */</span>
			<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f57900">end_chunk</span><span style="color:#000;font-weight:bold">:</span>
		<span style="color:#8f5902;font-style:italic">/* batch tlb flush per chunk to amortize cost */</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">freed_page_start</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">freed_page_end</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">spin_unlock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">pcpu_post_unmap_tlb_flush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span>
						  <span style="color:#000">freed_page_start</span><span style="color:#000;font-weight:bold">,</span>
						  <span style="color:#000">freed_page_end</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">cond_resched</span><span style="color:#000;font-weight:bold">();</span>
			<span style="color:#000">spin_lock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000;font-weight:bold">}</span>

		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">reintegrate</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">free_bytes</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">pcpu_unit_size</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#000">pcpu_reintegrate_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#204a87;font-weight:bold">else</span>
			<span style="color:#000">list_move_tail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">,</span>
				       <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_chunk_lists</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pcpu_sidelined_slot</span><span style="color:#000;font-weight:bold">]);</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ol>
<li>depopulate_slot은 depopulate해야되는 chunk들이 pcpu_to_depopulate_slot에 들어가있고 이 루틴에선 chunk들을 depopulate하는것으로 대강 파악된다.</li>
<li>first chunk외에 populate 됬다는의미는 vm 할당이 됬다는것을 의미한다.</li>
<li>depopulate는 결국 vm 할당된 영역을 할당해제 한다는것이다.</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_balance_populated - manage the amount of populated pages
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Maintain a certain amount of populated pages to satisfy atomic allocations.
</span><span style="color:#8f5902;font-style:italic"> * It is possible that this is called when physical memory is scarce causing
</span><span style="color:#8f5902;font-style:italic"> * OOM killer to be triggered.  We should avoid doing so until an actual
</span><span style="color:#8f5902;font-style:italic"> * allocation causes the failure as it is possible that requests can be
</span><span style="color:#8f5902;font-style:italic"> * serviced from already backed regions.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * CONTEXT:
</span><span style="color:#8f5902;font-style:italic"> * pcpu_lock (can be dropped temporarily)
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_balance_populated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#8f5902;font-style:italic">/* gfp flags passed to underlying allocators */</span>
	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">gfp_t</span> <span style="color:#000">gfp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">GFP_KERNEL</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">__GFP_NORETRY</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">__GFP_NOWARN</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">slot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nr_to_pop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">lockdep_assert_held</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><ul>
<li>원자량 할당을 충족하기 위해 채워진 일정 양의 페이지를 유지합니다.<br>
물리적 메모리가 부족할 때 호출되어 OOM 킬러가 트리거될 수 있습니다. 이미 지원된 지역에서 요청을 처리할 수 있기 때문에 실제 할당으로 인해 장애가 발생할 때까지 그렇게 하는 것은 피해야 합니다.</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * Ensure there are certain number of free populated pages for
</span><span style="color:#8f5902;font-style:italic">	 * atomic allocs.  Fill up from the most packed so that atomic
</span><span style="color:#8f5902;font-style:italic">	 * allocs don&#39;t increase fragmentation.  If atomic allocation
</span><span style="color:#8f5902;font-style:italic">	 * failed previously, always populate the maximum amount.  This
</span><span style="color:#8f5902;font-style:italic">	 * should prevent atomic allocs larger than PAGE_SIZE from keeping
</span><span style="color:#8f5902;font-style:italic">	 * failing indefinitely; however, large atomic allocs are not
</span><span style="color:#8f5902;font-style:italic">	 * something we support properly and can be highly unreliable and
</span><span style="color:#8f5902;font-style:italic">	 * inefficient.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
<span style="color:#f57900">retry_pop</span><span style="color:#000;font-weight:bold">:</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcpu_atomic_alloc_failed</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">nr_to_pop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PCPU_EMPTY_POP_PAGES_HIGH</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#8f5902;font-style:italic">/* best effort anyway, don&#39;t worry about synchronization */</span>
		<span style="color:#000">pcpu_atomic_alloc_failed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">nr_to_pop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">clamp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PCPU_EMPTY_POP_PAGES_HIGH</span> <span style="color:#ce5c00;font-weight:bold">-</span>
				  <span style="color:#000">pcpu_nr_empty_pop_pages</span><span style="color:#000;font-weight:bold">,</span>
				  <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PCPU_EMPTY_POP_PAGES_HIGH</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>원자성 할당에 사용할 수 있는 특정 페이지 수가 있는지 확인하십시오. 원자량 할당이 조각화를 증가시키지 않도록 가장 많이 채워야 합니다. 이전에 원자성 할당에 실패한 경우 항상 최대 양을 채웁니다. 이것은 PAGE_SIZE보다 큰 원자 할당이 계속 실패하는 것을 방지해야 한다. 그러나 큰 원자 할당은 우리가 적절하게 지원하지 않으며 매우 신뢰할 수 없고 비효율적일 수 있다.</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">slot</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_size_to_slot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PAGE_SIZE</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">slot</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">pcpu_free_slot</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">slot</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nr_unpop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">nr_to_pop</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#000">list_for_each_entry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_chunk_lists</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">slot</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">nr_unpop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_pages</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_populated</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nr_unpop</span><span style="color:#000;font-weight:bold">)</span>
				<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>

		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">nr_unpop</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>populate 안된 페이지가 존재하는지 확인한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">		<span style="color:#8f5902;font-style:italic">/* @chunk can&#39;t go away while pcpu_alloc_mutex is held */</span>
		<span style="color:#000">bitmap_for_each_clear_region</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">populated</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
					     <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_pages</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">min_t</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">re</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nr_to_pop</span><span style="color:#000;font-weight:bold">);</span>

			<span style="color:#000">spin_unlock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_populate_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gfp</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000">cond_resched</span><span style="color:#000;font-weight:bold">();</span>
			<span style="color:#000">spin_lock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#000">nr_to_pop</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">;</span>
				<span style="color:#000">pcpu_chunk_populated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#000">nr_to_pop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000;font-weight:bold">}</span>

			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">nr_to_pop</span><span style="color:#000;font-weight:bold">)</span>
				<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>populate 안된 페이지들은 populate 시킨다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nr_to_pop</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">/* ran out of chunks to populate, create a new one and retry */</span>
		<span style="color:#000">spin_unlock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000">chunk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_create_chunk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gfp</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#000">cond_resched</span><span style="color:#000;font-weight:bold">();</span>
		<span style="color:#000">spin_lock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">pcpu_chunk_relocate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">retry_pop</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

</code></pre></div><p>populate page가 여유분이 있으면 chunk를 하나 생성한다.</p>
<h2 id="pcpu_balance_workfn-2">pcpu_balance_workfn 2</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_balance_workfn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">work_struct</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">work</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
</code></pre></div><p>이제 다시 봐보자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">mutex_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_alloc_mutex</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">spin_lock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>

	<span style="color:#000">pcpu_balance_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>free slot에 있는 모든 chunk에 대해서 depopulate를 하고 해제해버린다. 즉 free slot을 일단 한번 비운다.(1개빼고)
주석에서 pcpu_balance_free를 두번 호출한 이유에 대해서 나오는데 즉 첫번째 pcpu_balance_free 호출에서 depoulate를 많이 시켜놓으면 pcpu_nr_empty_pop_pages가 줄어들고, 만약 충분한 pcpu_nr_empty_pop_pages가 없으면 pcpu_reclaim_populated에서 depopulate가 요청된 chunk들을 다시 일반 slot으로 보내고 나중에 적절할때 해제한다나 뭐라나.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">pcpu_reclaim_populated</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>depoulate slot에 있는 chunk들을 이제 depopulate 시킨다. 해제는 안하고 만약 chunk 전체가 free byte면 일반 slot으로 넘기고 좀 남아잇으면 sidelined slot에 넣어놓는다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">pcpu_balance_populated</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>최대 PCPU_EMPTY_POP_PAGES_HIGH(4)개 page만큼을 PAGE_SIZE slot ~ free slot까지 돌면서 popluate 안된것들이 있으면 popluate를 좀 시켜준다. 만약 popluate가 다 되있다면 chunk를 하나 더 만들고 새로생긴 chunk는 일반 slot에 갈것이다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">pcpu_balance_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>free slot에 있는것들 중에 popluate가 하나도 안된것들은 해제시켜버린다. pcpu_balance_populated</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#000">spin_unlock_irq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_lock</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#000">mutex_unlock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pcpu_alloc_mutex</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ea349711d868e9d1493dd1bcf661a200">2 - scan_hint</h1>
    <div class="lead">scan_hint</div>
	<h1 id="introudce">Introudce</h1>
<p><a href="https://lwn.net/Articles/780936/">introudce percpu block scan_hint</a></p>
<p>Hi everyone,</p>
<p>It was reported a while [1] that an increase in allocation alignment requirement [2] caused the percpu memory allocator to do significantly more work.</p>
<p>After spending quite a bit of time diving into it, it seems the crux was the following:</p>
<ol>
<li>chunk management by free_bytes caused allocations to scan over chunks that could not fit due to fragmentation.</li>
<li>per block fragmentation required scanning from an early first_free bit causing allocations to repeat work.</li>
</ol>
<p>This series introduces a scan_hint for pcpu_block_md and merges the paths used to manage the hints. The scan_hint represents the largest known free area prior to the contig_hint.
There are some caveats to this. First, it may not necessarily be the largest area as we do partial updates based on freeing of regions and failed scanning in pcpu_alloc_area().
Second, if contig_hint == scan_hint, then scan_hint_start &gt; contig_hint_start is possible. This is necessary for scan_hint discovery when refreshing the hint of a block.</p>
<p>A necessary change is to enforce a block to be the size of a page. This let&rsquo;s the management of nr_empty_pop_pages to be done by breaking and making full contig_hints in the hint update paths. Prior, this was done by piggy backing off of refreshing the chunk contig_hint as it performed a full scan and counting empty full pages.</p>
<p>The following are the results found using the workload provided in [3].</p>
<pre><code>    branch        | time
   ------------------------
    5.0-rc7       | 69s
    [2] reverted  | 44s
    scan_hint     | 39s
</code></pre>
<p>The times above represent the approximate average across multiple runs.
I tested based on a basic 1M 16-byte allocation pattern with no alignment requirement and times did not differ between 5.0-rc7 and scan_hint.</p>
<p>[1] <a href="https://lore.kernel.org/netdev/CANn89iKb_vW+LA-91RV=zuAqbNycPFUYW54w_S=KZ3HdcWPw6Q@mail.gmail.com/">https://lore.kernel.org/netdev/CANn89iKb_vW+LA-91RV=zuAqbNycPFUYW54w_S=KZ3HdcWPw6Q@mail.gmail.com/</a>
[2] <a href="https://lore.kernel.org/netdev/20181116154329.247947-1-edumazet@google.com/">https://lore.kernel.org/netdev/20181116154329.247947-1-edumazet@google.com/</a>
[3] <a href="https://lore.kernel.org/netdev/vbfzhrj9smb.fsf@mellanox.com/">https://lore.kernel.org/netdev/vbfzhrj9smb.fsf@mellanox.com/</a></p>
<p>This patchset contains the following 12 patches:
0001-percpu-update-free-path-with-correct-new-free-region.patch
0002-percpu-do-not-search-past-bitmap-when-allocating-an-.patch
0003-percpu-introduce-helper-to-determine-if-two-regions-.patch
0004-percpu-manage-chunks-based-on-contig_bits-instead-of.patch
0005-percpu-relegate-chunks-unusable-when-failing-small-a.patch
0006-percpu-set-PCPU_BITMAP_BLOCK_SIZE-to-PAGE_SIZE.patch
0007-percpu-add-block-level-scan_hint.patch
0008-percpu-remember-largest-area-skipped-during-allocati.patch
0009-percpu-use-block-scan_hint-to-only-scan-forward.patch
0010-percpu-make-pcpu_block_md-generic.patch
0011-percpu-convert-chunk-hints-to-be-based-on-pcpu_block.patch
0012-percpu-use-chunk-scan_hint-to-skip-some-scanning.patch</p>
<p>0001 fixes an issue where the chunk contig_hint was being updated improperly with the new region&rsquo;s starting offset and possibly differing contig_hint.
0002 fixes possibly scanning pass the end of the bitmap.
0003 introduces a helper to do region overlap comparison.
0004 switches to chunk management by contig_hint rather than free_bytes.
0005 moves chunks that fail to allocate to the empty block list to prevent excess scanning with of chunks with small contig_hints and poor alignment.
0006 introduces the constraint PCPU_BITMAP_BLOCK_SIZE == PAGE_SIZE and modifies nr_empty_pop_pages management to be a part of the hint updates.
0007-0009 introduces percpu block scan_hint. 0010 makes pcpu_block_md generic so chunk hints can be managed as a pcpu_block_md responsible for more bits. 0011-0012 add chunk scan_hints.</p>
<p>This patchset is on top of percpu#master a3b22b9f11d9.</p>
<p>diffstats below:</p>
<p>Dennis Zhou (12):
percpu: update free path with correct new free region.
percpu: do not search past bitmap when allocating an area.
percpu: introduce helper to determine if two regions overlap.
percpu: manage chunks based on contig_bits instead of free_bytes.
percpu: relegate chunks unusable when failing small allocations.
percpu: set PCPU_BITMAP_BLOCK_SIZE to PAGE_SIZE.
percpu: add block level scan_hint.
percpu: remember largest area skipped during allocation.
percpu: use block scan_hint to only scan forward.
percpu: make pcpu_block_md generic.
percpu: convert chunk hints to be based on pcpu_block_md.
percpu: use chunk scan_hint to skip some scanning.</p>
<hr>
<h1 id="soruce">soruce</h1>
<p>scan_hint를 사용하는 함수를 전부 들여다본다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * pcpu_next_hint - determine which hint to use
</span><span style="color:#8f5902;font-style:italic"> * @block: block of interest
</span><span style="color:#8f5902;font-style:italic"> * @alloc_bits: size of allocation
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * This determines if we should scan based on the scan_hint or first_free.
</span><span style="color:#8f5902;font-style:italic"> * In general, we want to scan from first_free to fulfill allocations by
</span><span style="color:#8f5902;font-style:italic"> * first fit.  However, if we know a scan_hint at position scan_hint_start
</span><span style="color:#8f5902;font-style:italic"> * cannot fulfill an allocation, we can begin scanning from there knowing
</span><span style="color:#8f5902;font-style:italic"> * the contig_hint will be our fallback.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">pcpu_next_hint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">block</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">alloc_bits</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">	 * The three conditions below determine if we can skip past the
</span><span style="color:#8f5902;font-style:italic">	 * scan_hint.  First, does the scan hint exist.  Second, is the
</span><span style="color:#8f5902;font-style:italic">	 * contig_hint after the scan_hint (possibly not true iff
</span><span style="color:#8f5902;font-style:italic">	 * contig_hint == scan_hint).  Third, is the allocation request
</span><span style="color:#8f5902;font-style:italic">	 * larger than the scan_hint.
</span><span style="color:#8f5902;font-style:italic">	 */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
	    <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
	    <span style="color:#000">alloc_bits</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">first_free</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

</code></pre></div><p><a href="https://jhnyang.tistory.com/284">first fit이란</a></p>
<p>scan_hint를 기준으로 scan할지, first_free기준으로 scan할지 선택한다. 일반적으로 first_free를 first fit으로 할당을 수행한다. 하지만 scan_hint에서 못하면 conting_hint에서 한다(??)</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * pcpu_update_empty_pages - update empty page counters
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @nr: nr of empty pages
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * This is used to keep track of the empty pages now based on the premise
</span><span style="color:#8f5902;font-style:italic"> * a md_block covers a page.  The hint update functions recognize if a block
</span><span style="color:#8f5902;font-style:italic"> * is made full or broken to calculate deltas for keeping track of free pages.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_update_empty_pages</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_empty_pop_pages</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">pcpu_reserved_chunk</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">isolated</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">pcpu_nr_empty_pop_pages</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * pcpu_region_overlap - determines if two regions overlap
</span><span style="color:#8f5902;font-style:italic"> * @a: start of first region, inclusive
</span><span style="color:#8f5902;font-style:italic"> * @b: end of first region, exclusive
</span><span style="color:#8f5902;font-style:italic"> * @x: start of second region, inclusive
</span><span style="color:#8f5902;font-style:italic"> * @y: end of second region, exclusive
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * This is used to determine if the hint region [a, b) overlaps with the
</span><span style="color:#8f5902;font-style:italic"> * allocated region [x, y).
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * IAMROOT, 2022.01.15:
</span><span style="color:#8f5902;font-style:italic"> * - (a, b) 와 (x, y)가 겹치는지 확인한다.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">pcpu_region_overlap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_block_update - updates a block given a free area
</span><span style="color:#8f5902;font-style:italic"> * @block: block of interest
</span><span style="color:#8f5902;font-style:italic"> * @start: start offset in block
</span><span style="color:#8f5902;font-style:italic"> * @end: end offset in block
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Updates a block given a known free area.  The region [start, end) is
</span><span style="color:#8f5902;font-style:italic"> * expected to be the entirety of the free area within a block.  Chooses
</span><span style="color:#8f5902;font-style:italic"> * the best starting offset if the contig hints are equal.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_block_update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">block</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * IAMROOT, 2022.01.15:
</span><span style="color:#8f5902;font-style:italic"> * - start ~ end전까지 0인 bit가 되며, contig는 즉 연속적인 free size를 의미한다.
</span><span style="color:#8f5902;font-style:italic"> */</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">contig</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">first_free</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">first_free</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * IAMROOT, 2022.01.15:
</span><span style="color:#8f5902;font-style:italic"> * - start가 0이면 처음부터 free임으로 left_free가 contig가 된다.
</span><span style="color:#8f5902;font-style:italic"> */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">left_free</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">contig</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * IAMROOT, 2022.01.15:
</span><span style="color:#8f5902;font-style:italic"> * - 마지막까지 contig면 right부터 contig이므로 right_free를 갱신한다.
</span><span style="color:#8f5902;font-style:italic"> */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr_bits</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">right_free</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">contig</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * IAMROOT, 2022.01.15:
</span><span style="color:#8f5902;font-style:italic"> * - size가 큰것이 우선순위가 높다.
</span><span style="color:#8f5902;font-style:italic"> * - 아에 0번째에 위치하거나 우측에 위치하는게 우선순위가 높다.
</span><span style="color:#8f5902;font-style:italic"> * - contig가 기존 config_hint보다 클경우
</span><span style="color:#8f5902;font-style:italic"> *   scan_hint &lt;- contig_hint &lt;- contig 로 밀어내기를 한다. 예외상황일 경우엔
</span><span style="color:#8f5902;font-style:italic"> *   scan_hint를 초기화 시켜버린다.
</span><span style="color:#8f5902;font-style:italic"> */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">contig</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">/* promote the old contig_hint to be the new scan_hint */</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span> <span style="color:#ce5c00;font-weight:bold">=</span>
					<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span><span style="color:#000;font-weight:bold">;</span>
				<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">				 * The old contig_hint == scan_hint.  But, the
</span><span style="color:#8f5902;font-style:italic">				 * new contig is larger so hold the invariant
</span><span style="color:#8f5902;font-style:italic">				 * scan_hint_start &lt; contig_hint_start.
</span><span style="color:#8f5902;font-style:italic">				 */</span>
				<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">contig</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * IAMROOT, 2022.01.15:
</span><span style="color:#8f5902;font-style:italic"> * - size가 동일한 경우, 위치가 아에 처음이거나 기존 contig_hint_start보다
</span><span style="color:#8f5902;font-style:italic"> *   우측에 있으면 contig_hint_start를 start로 갱신한다.
</span><span style="color:#8f5902;font-style:italic"> */</span>
	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">contig</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>

		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
		    <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">||</span>
		     <span style="color:#000">__ffs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">__ffs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span><span style="color:#000;font-weight:bold">)))</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#8f5902;font-style:italic">/* start has a better alignment so use it */</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
			    <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span><span style="color:#000;font-weight:bold">)</span>
				<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span> <span style="color:#ce5c00;font-weight:bold">||</span>
			   <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">			 * Knowing contig == contig_hint, update the scan_hint
</span><span style="color:#8f5902;font-style:italic">			 * if it is farther than or larger than the current
</span><span style="color:#8f5902;font-style:italic">			 * scan_hint.
</span><span style="color:#8f5902;font-style:italic">			 */</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">contig</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * IAMROOT, 2022.01.15:
</span><span style="color:#8f5902;font-style:italic"> * - contig_hint보다 현재 contig가 작은 경우.
</span><span style="color:#8f5902;font-style:italic"> *   scan_hint와 비교하여 더 유리한경우 scan_hint를 contig로 대체한다.
</span><span style="color:#8f5902;font-style:italic"> */</span>
	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">		 * The region is smaller than the contig_hint.  So only update
</span><span style="color:#8f5902;font-style:italic">		 * the scan_hint if it is larger than or equal and farther than
</span><span style="color:#8f5902;font-style:italic">		 * the current scan_hint.
</span><span style="color:#8f5902;font-style:italic">		 */</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
		     <span style="color:#000;font-weight:bold">(</span><span style="color:#000">contig</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span> <span style="color:#ce5c00;font-weight:bold">||</span>
		      <span style="color:#000;font-weight:bold">(</span><span style="color:#000">contig</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
		       <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span><span style="color:#000;font-weight:bold">))))</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">contig</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_chunk_refresh_hint - updates metadata about a chunk
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @full_scan: if we should scan from the beginning
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Iterates over the metadata blocks to find the largest contig area.
</span><span style="color:#8f5902;font-style:italic"> * A full scan can be avoided on the allocation path as this is triggered
</span><span style="color:#8f5902;font-style:italic"> * if we broke the contig_hint.  In doing so, the scan_hint will be before
</span><span style="color:#8f5902;font-style:italic"> * the contig_hint or after if the scan_hint == contig_hint.  This cannot
</span><span style="color:#8f5902;font-style:italic"> * be prevented on freeing as we want to find the largest area possibly
</span><span style="color:#8f5902;font-style:italic"> * spanning blocks.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_chunk_refresh_hint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">full_scan</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk_md</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">chunk_md</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#8f5902;font-style:italic">/* promote scan_hint to contig_hint */</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">full_scan</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint_start</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">scan_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">first_free</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000">chunk_md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000">pcpu_for_each_md_free_region</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">pcpu_block_update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk_md</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">bits</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

</code></pre></div><p>metadata block위에서 iteration하여 가장 큰 contig 영역을 찾는다.
full_scan 이란게 마치 contig까지 새로 찾는것으로 보이며, full_scan이 아니면 scan_hint를 초기화시킨다.
bitt_off는 free라고 알고있는 지점의 마지막이다.
full_scan이 아니면서 scan_hint가 있는 경우 : bit_off는 scan_hint 다음부터. contig_hint를 scan_hint로 update하고 scan_hint는 초기화.
그 나머지의 경우(full_scan이거나 scan_hint가 없는경우) : bit_off 는 무조건 first_free부터, contig_hint는 초기화</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * Metadata free area iterators.  These perform aggregation of free areas
</span><span style="color:#8f5902;font-style:italic"> * based on the metadata blocks and return the offset @bit_off and size in
</span><span style="color:#8f5902;font-style:italic"> * bits of the free area @bits.  pcpu_for_each_fit_region only returns when
</span><span style="color:#8f5902;font-style:italic"> * a fit is found for the allocation request.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#8f5902;font-style:italic">#define pcpu_for_each_md_free_region(chunk, bit_off, bits)		\
</span><span style="color:#8f5902;font-style:italic">	for (pcpu_next_md_free_region((chunk), &amp;(bit_off), &amp;(bits));	\
</span><span style="color:#8f5902;font-style:italic">	     (bit_off) &lt; pcpu_chunk_map_bits((chunk));			\
</span><span style="color:#8f5902;font-style:italic">	     (bit_off) += (bits) + 1,					\
</span><span style="color:#8f5902;font-style:italic">	     pcpu_next_md_free_region((chunk), &amp;(bit_off), &amp;(bits)))
</span><span style="color:#8f5902;font-style:italic"></span>
</code></pre></div><p>(번역)메타데이터 사용 가능 영역 반복자. 이 명령은 메타데이터 블록을 기반으로 사용 가능한 영역을 집계하고 오프셋 @bit_off 및 사용 가능한 영역 @bit의 비트 단위로 크기를 반환합니다. pcpu_for_etach_fit_region은 할당 요청에 대한 적합치가 발견된 경우에만 반환합니다.
pcpu_next_md_free_region을통해서 free의 start 지점(bitt_off)과 size(bits)가 한덩이씩 튀어나온다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * pcpu_next_md_free_region - finds the next hint free area
</span><span style="color:#8f5902;font-style:italic"> * @chunk: chunk of interest
</span><span style="color:#8f5902;font-style:italic"> * @bit_off: chunk offset
</span><span style="color:#8f5902;font-style:italic"> * @bits: size of free area
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Helper function for pcpu_for_each_md_free_region.  It checks
</span><span style="color:#8f5902;font-style:italic"> * block-&gt;contig_hint and performs aggregation across blocks to find the
</span><span style="color:#8f5902;font-style:italic"> * next hint.  It modifies bit_off and bits in-place to be consumed in the
</span><span style="color:#8f5902;font-style:italic"> * loop.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">pcpu_next_md_free_region</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_chunk</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">,</span>
				     <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_off_to_block_index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">block_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_off_to_block_off</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span><span style="color:#000;font-weight:bold">);</span>
	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pcpu_block_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">block</span><span style="color:#000;font-weight:bold">;</span>

	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chunk</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">md_blocks</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">pcpu_chunk_nr_blocks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chunk</span><span style="color:#000;font-weight:bold">);</span>
	     <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">/* handles contig area across blocks */</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">left_free</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">left_free</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">)</span>
				<span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
			<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>

		<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic">		 * This checks three things.  First is there a contig_hint to
</span><span style="color:#8f5902;font-style:italic">		 * check.  Second, have we checked this hint before by
</span><span style="color:#8f5902;font-style:italic">		 * comparing the block_off.  Third, is this the same as the
</span><span style="color:#8f5902;font-style:italic">		 * right contig hint.  In the last case, it spills over into
</span><span style="color:#8f5902;font-style:italic">		 * the next block and should be handled by the contig area
</span><span style="color:#8f5902;font-style:italic">		 * across blocks code.
</span><span style="color:#8f5902;font-style:italic">		 */</span>
		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">block_off</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
		    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcpu_block_off_to_off</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span>
					<span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">contig_hint_start</span><span style="color:#000;font-weight:bold">);</span>
			<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#8f5902;font-style:italic">/* reset to satisfy the second predicate above */</span>
		<span style="color:#000">block_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>

		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">right_free</span><span style="color:#000;font-weight:bold">;</span>
		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bit_off</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">PCPU_BITMAP_BLOCK_BITS</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">block</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">right_free</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>bit_off부터 시작해 탐색을 수행한다.
contig_hint가 존재하고, contig_hint가 오른쪽에 있으며, contig의 end주소가 PCPU_BITMAP_BLOCK_BITS넘지 않으면(이걸 왜하는진 모르겠다.) contig로 return 쳐버린다. 만약 end주소가 PCU_BITMAP_BLOCK_BITS를 넘으면 다음 block까지 contig가 연결되있다는것이고 이건 right_free가 존재할것이므로 아래 right_free처리에 맡긴다는 개념으로 넘어가는것이다.
for문의 마지막 right를 기준으로 offset을 구한다. 그리고 다음 iter에서 그전에 right가 존재하면 left를 붙이고, 만약 전부 비어있다면 (block-&gt;left_free == PCPU_BITMAP_BLOCK_BITS) 다음 block까지 계속 left를 바라본다.</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 The Docsy Authors All Rights Reserved</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">개인정보 보호 정책</a></small>
	
		<p class="mt-2"><a href="/about/">About Goldydocs</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>


















<script src="/js/main.min.630faeed9abb9fd07c67681cb98128bbcde59398a65eacf9e96dc1fa4461ddc2.js" integrity="sha256-Yw&#43;u7Zq7n9B8Z2gcuYEou83lk5imXqz56W3B&#43;kRh3cI=" crossorigin="anonymous"></script>




  </body>
</html>
